<div class="container py-4" data-page-id="carnivals-show">
    <div class="row">
        <div class="col-lg-8">
            <!-- Hosting Club Banner -->
            <% if (hostClub) { %>
                <div class="card shadow mb-4 border-primary">
                    <div class="card-body bg-light">
                        <div class="d-flex align-items-center">
                            <% 
                            // Show host club logo first, then fall back to carnival logo, then to missing.svg
                            const hostingLogoUrl = hostClub.logoUrl || carnival.clubLogoURL || '/icons/missing.svg';
                            %>
                            <img src="<%= hostingLogoUrl %>" alt="<%= hostClub.clubName %> Logo" 
                                 class="me-3" style="height: 60px; width: auto;">
                            <div class="flex-grow-1">
                                <h5 class="mb-1 text-primary">Hosted by</h5>
                                <h4 class="mb-2">
                                    <% if (hostClub.isPubliclyListed && hostClub.isActive) { %>
                                        <a href="/clubs/<%= hostClub.id %>" class="text-decoration-none text-primary">
                                            <%= hostClub.clubName %>
                                        </a>
                                    <% } else { %>
                                        <span class="<%= hostClub.isActive ? '' : 'club-inactive-label' %>">
                                            <%= hostClub.clubName %>
                                            <% if (hostClub.isActive === false) { %>
                                                <span class="club-inactive-badge">Inactive</span>
                                            <% } %>
                                        </span>
                                    <% } %>
                                </h4>
                                <% if (hostClub.location) { %>
                                    <p class="mb-0 text-muted">
                                        <i class="bi bi-geo-alt me-1"></i><%= hostClub.location %>
                                        <% if (hostClub.state) { %>
                                            <span class="badge state-<%= hostClub.state.toLowerCase() %> ms-2"><%= hostClub.state %></span>
                                        <% } %>
                                    </p>
                                <% } %>
                            </div>
                            <% if (hostClub.isPubliclyListed && hostClub.isActive) { %>
                                <div>
                                    <a href="/clubs/<%= hostClub.id %>" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye me-1"></i>View Club Profile
                                    </a>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Main Carnival Information -->
            <div class="card shadow mb-4">
                <!-- Inactive Carnival Warning -->
                <% if (isInactiveCarnival && !canManage) { %>
                    <div class="alert alert-warning border-0 rounded-0 mb-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.25rem;"></i>
                            <div>
                                <strong>This carnival is no longer active.</strong><br>
                                <small>Contact details have been hidden and registration is no longer available. This information is kept for historical purposes.</small>
                            </div>
                        </div>
                    </div>
                <% } %>
                
                <% if (carnival.promotionalImageURL) { %>
                    <img src="<%= carnival.promotionalImageURL %>" class="card-img-top" 
                         alt="<%= carnival.title %>" style="height: 300px; object-fit: cover;">
                <% } %>
                
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h3 mb-2"><%= carnival.title %></h1>
                            <div class="mb-2">
                                <% if (carnival.state) { %>
                                    <span class="badge state-<%= carnival.state.toLowerCase() %> me-2"><%= carnival.state %></span>
                                <% } %>
                                <% if (!carnival.isActive) { %>
                                    <span class="badge bg-danger">Inactive</span>
                                <% } else if (carnival.date && carnival.date instanceof Date && !isNaN(carnival.date)) { %>
                                    <% if (carnival.date >= new Date()) { %>
                                        <span class="badge bg-primary">Upcoming</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary">Past Carnival</span>
                                    <% } %>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark">Date TBA</span>
                                <% } %>
                                <% if (!carnival.isManuallyEntered && carnival.lastMySidelineSync) { %>
                                    <span class="badge bg-warning text-dark">MySideline Import</span>
                                <% } %>
                                <% if (canTakeOwnership) { %>
                                    <span class="badge bg-info">Available to Claim</span>
                                <% } %>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <!-- View Gallery Button -->
                            <a href="/carnivals/<%= carnival.id %>/gallery" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-images me-1"></i>
                                View Gallery
                            </a>
                            <!-- Logo -->
                            <% if (carnival.clubLogoURL) { %>
                                <% 
                                // Show carnival logo first, then fall back to hosting club logo, then to missing.svg
                                const carnivalLogoUrl = carnival.clubLogoURL || (carnival.creator && carnival.creator.club && carnival.creator.club.logoUrl) || '/icons/missing.svg';
                                %>
                                <img src="<%= carnivalLogoUrl %>" alt="Club Logo" 
                                     style="width: 80px; height: 80px; object-fit: contain;">
                            <% } else { %>
                                <% 
                                // No carnival logo, check for club logo, otherwise use missing.svg
                                const fallbackLogoUrl = (carnival.creator && carnival.creator.club && carnival.creator.club.logoUrl) || '/icons/missing.svg';
                                %>
                                <img src="<%= fallbackLogoUrl %>" alt="Club Logo" 
                                     style="width: 80px; height: 80px; object-fit: contain;">
                            <% } %>
                        </div>
                    </div>

                    <!-- Admin Actions Section -->
                    <% if (user && user.isAdmin) { %>
                        <div class="alert alert-warning mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-shield-fill me-2"></i>
                                    <strong>Administrator Actions</strong>
                                    <div class="small text-muted mt-1">
                                        You have admin privileges for this carnival
                                    </div>
                                </div>
                                <div class="d-flex gap-2 flex-wrap">
                                    <!-- Admin Activate/Deactivate Button -->
                                    <% if (carnival.isActive) { %>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                data-toggle-carnival-status="<%= carnival.id %>"
                                                data-carnival-title="<%= carnival.title %>"
                                                data-current-status="true">
                                            <i class="bi bi-eye-slash"></i> Deactivate
                                        </button>
                                    <% } else { %>
                                        <button type="button" class="btn btn-outline-tertiary btn-sm" 
                                                data-toggle-carnival-status="<%= carnival.id %>"
                                                data-carnival-title="<%= carnival.title %>"
                                                data-current-status="false">
                                            <i class="bi bi-eye"></i> Reactivate
                                        </button>
                                    <% } %>
                                    
                                    <!-- View in Admin Dashboard -->
                                    <a href="/admin/carnivals?search=<%= encodeURIComponent(carnival.title) %>" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-list-ul"></i> View in Admin
                                    </a>
                                    
                                    <!-- Admin Claim Button (if not already owned by someone) -->
                                    <% if (!canEditCarnival && user && user.isAdmin) { %>
                                        <a href="/admin/carnivals/<%= carnival.id %>/claim" class="btn btn-outline-tertiary btn-sm">
                                            <i class="bi bi-hand-thumbs-up"></i> Admin Claim
                                        </a>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% } %>

                    <!-- Carnival Owner Actions Section -->
                    <% if (canEditCarnival || canTakeOwnership) { %>
                        <div class="alert alert-info mb-4">
                            <div>
                                <div>
                                    <i class="bi bi-gear-fill me-2"></i>
                                    <strong>
                                        <% if (canTakeOwnership) { %>
                                            You can claim ownership of this MySideline carnival
                                        <% } else { %>
                                            You are the organiser of this carnival
                                        <% } %>
                                    </strong>
                                </div>
                                
                                <div class="d-flex gap-2 justify-content-end mt-3">
                                    <% if (canTakeOwnership) { %>
                                        <button type="button" class="btn btn-tertiary btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#claimOwnershipModal">
                                            <i class="bi bi-hand-thumbs-up"></i> Claim Carnival
                                        </button>
                                    <% } %>
                                    
                                    <% if (canEditCarnival) { %>
                                        <a href="/carnivals/<%= carnival.id %>/attendees" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-people"></i> Attending Clubs
                                        </a>
                                        <a href="/carnivals/<%= carnival.id %>/players" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-list-ul"></i> All Players
                                        </a>                   
                                        <a href="/carnivals/<%= carnival.id %>/sponsors" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-building me-1"></i> Sponsors
                                        </a>                                        
                                        <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#emailAttendeesModal">
                                                <i class="bi bi-envelope"></i> Email Attendees
                                            </button>
                                        <% } %>
                                        <a href="/carnivals/<%= carnival.id %>/edit" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-pencil"></i> Edit Carnival                                        
                                        </a>                    
                                    <% } %>
                                    <% if (canEditCarnival && carnival.lastMySidelineSync) { %>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#releaseOwnershipModal">
                                            <i class="bi bi-unlock"></i> Release Ownership
                                        </button>
                                    <% } %>
                                    <% if (canMergeCarnival) { %>
                                        <button type="button" class="btn btn-outline-tertiary btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#mergeCarnivalModal">
                                            <i class="bi bi-arrow-down-up"></i> Merge Carnival
                                        </button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% } %>

                    <!-- Public Actions section removed - View Gallery moved to header -->

                    <!-- Key Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>
                                <i class="bi bi-calendar3 text-primary"></i> Date & Time
                                <button type="button" class="btn btn-link btn-sm p-0 align-baseline ms-2 help-trigger" data-help-key="date" data-help-modal="help-carnival-show" aria-label="Help: Date & Time">
                                    <i class="bi bi-question-circle text-primary"></i>
                                </button>
                            </h5>
                            <p class="mb-3">
                                <%- include('../partials/carnival-date', { 
                                    carnival: carnival, 
                                    format: 'full',
                                    showIcon: false,
                                    addClass: 'fs-6 fw-semibold'
                                }) %>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h5>
                                <i class="bi bi-geo-alt text-primary"></i> Location
                                <button type="button" class="btn btn-link btn-sm p-0 align-baseline ms-2 help-trigger" data-help-key="location" data-help-modal="help-carnival-show" aria-label="Help: Location">
                                    <i class="bi bi-question-circle text-primary"></i>
                                </button>
                            </h5>
                            <%- include('../partials/carnival-address', { 
                                carnival: carnival, 
                                addressClass: 'text-primary fw-semibold',
                                showIcon: false
                            }) %>
                        </div>
                    </div>

                    <!-- Schedule Details -->
                    <div class="mb-4">
                        <h5><i class="bi bi-clock text-primary"></i> Schedule Details</h5>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0" style="white-space: pre-line;"><%= carnival.scheduleDetails %></p>
                        </div>
                    </div>

                    <!-- Registration & Fees -->
                    <% if (carnival.registrationLink || carnival.feesDescription) { %>
                        <!-- Registration Section - Full Width -->
                        <% if (carnival.registrationLink) { %>
                            <div class="mb-4">
                                <h5><i class="bi bi-person-plus text-success"></i> Player Registration</h5>
                                <% 
                                // Check if carnival is inactive OR if the carnival date is in the past
                                const isPastCarnival = carnival.date && carnival.date instanceof Date && !isNaN(carnival.date) && carnival.date < new Date();
                                const shouldDisableRegistration = !carnival.isActive || isPastCarnival;
                                %>
                                <% if (shouldDisableRegistration) { %>
                                    <!-- Disabled registration for inactive carnivals or past carnivals -->
                                    <button class="btn btn-secondary" disabled>
                                        <i class="bi bi-x-circle"></i> Registration Closed
                                    </button>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <% if (!carnival.isActive) { %>
                                                Registration is no longer available for this carnival.
                                            <% } else if (isPastCarnival) { %>
                                                Registration is closed - this carnival has already taken place.
                                            <% } %>
                                        </small>
                                    </div>
                                <% } else { %>
                                    <a href="<%= carnival.registrationLink %>" 
                                       class="btn btn-tertiary" 
                                       target="_blank">
                                        <i class="bi bi-box-arrow-up-right"></i> Register Now
                                        <% if (isMySidelineCarnival) { %>
                                            <i class="bi bi-info-circle ms-1" style="font-size: 0.875rem;"></i>
                                        <% } %>
                                    </a>
                                    <% if (isMySidelineCarnival) { %>
                                        <div class="mt-2">
                                            <small class="text-warning">
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                Registration via MySideline
                                            </small>
                                        </div>
                                    <% } %>
                                <% } %>
                            </div>
                        <% } %>
                        
                        <!-- Fees Section - Full Width -->
                        <% if (carnival.feesDescription) { %>
                            <div class="mb-4">
                                <h5><i class="bi bi-currency-dollar text-info"></i> Fees</h5>
                                <p><%= carnival.feesDescription %></p>
                            </div>
                        <% } %>
                    <% } %>

                    <!-- Volunteers -->
                    <% if (carnival.callForVolunteers) { %>
                        <div class="mb-4">
                            <h5><i class="bi bi-hand-thumbs-up text-warning"></i> Volunteers Needed</h5>
                            <div class="alert alert-warning">
                                <p class="mb-0"><%= carnival.callForVolunteers %></p>
                            </div>
                        </div>
                    <% } %>

                    <!-- Draw Information -->
                    <% if (carnival.drawFileURL) { %>
                        <div class="draw-section">
                            <h5><i class="bi bi-trophy text-warning"></i> Carnival Draw </h5>
                            <% if (carnival.drawTitle) { %>
                                <h6><%= carnival.drawTitle %></h6>
                            <% } %>
                            <% if (carnival.drawDescription) { %>
                                <p><%= carnival.drawDescription %></p>
                            <% } %>
                            <a href="<%= carnival.drawFileURL %>" class="btn btn-outline-tertiary" target="_blank">
                                <i class="bi bi-download"></i> Download Draw
                                <% if (carnival.drawFileName) { %>
                                    (<%= carnival.drawFileName %>)
                                <% } %>
                            </a>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Attending Clubs Section -->
            <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-primary">
                        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Attending Clubs</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <% carnival.attendingClubs.forEach((club, index) => { %>
                                <div class="col-lg-6 col-md-12">
                                    <div class="d-flex align-items-start p-3 border rounded bg-light h-100">
                                        <% if (club.logoUrl) { %>
                                            <img src="<%= club.logoUrl %>" alt="<%= club.clubName %> Logo" 
                                                 class="me-3 flex-shrink-0" style="height: 50px; width: auto; max-width: 70px; object-fit: contain;">
                                        <% } else { %>
                                            <div class="me-3 flex-shrink-0 d-flex align-items-center justify-content-center bg-white border rounded" 
                                                 style="height: 50px; width: 70px; min-width: 70px;">
                                                <i class="bi bi-shield text-muted" style="font-size: 1.25rem;"></i>
                                            </div>
                                        <% } %>
                                        <div class="flex-grow-1 min-width-0">
                                            <% if (club.isPubliclyListed && club.isActive) { %>
                                                <a href="/clubs/<%= club.id %>" class="text-decoration-none fw-bold h6 mb-1 d-block" title="<%= club.clubName %>">
                                                    <%= club.clubName %>
                                                </a>
                                            <% } else { %>
                                                <div class="fw-bold h6 mb-1 d-flex align-items-start">
                                                    <span class="flex-grow-1 me-2" title="<%= club.clubName %>">
                                                        <%= club.clubName %>
                                                    </span>
                                                    <% if (!club.isActive) { %>
                                                        <span class="badge bg-secondary flex-shrink-0">Inactive</span>
                                                    <% } %>
                                                </div>
                                            <% } %>
                                            <div class="text-muted small d-flex align-items-center flex-wrap">
                                                <% if (club.state) { %>
                                                    <span class="me-2"><%= club.state %></span>
                                                <% } %>
                                                <% if (club.location) { %>
                                                    <% if (club.state) { %>
                                                        <span class="me-2">â€¢</span>
                                                    <% } %>
                                                    <span class="flex-grow-1" title="<%= club.location %>"><%= club.location %></span>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                        <% if (canEditCarnival || canTakeOwnership) { %>
                            <div class="text-center mt-4">
                                <a href="/carnivals/<%= carnival.id %>/attendees" class="btn btn-outline-tertiary">
                                    <i class="bi bi-list-ul"></i> Manage Attendees
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
            <% } else if (canEditCarnival || canTakeOwnership) { %>
                <!-- Show empty state for carnival owners -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-primary">
                        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Attending Clubs</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                        </div>
                        <h6 class="text-muted mb-3">No clubs registered yet</h6>
                        <p class="text-muted mb-4">Start building your carnival by adding the first attending club.</p>
                        <a href="/carnivals/<%= carnival.id %>/attendees" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add First Club
                        </a>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Sponsors Section -->
            <% if (sponsors && sponsors.length > 0) { %>
                <div class="card shadow mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-star-fill"></i> Carnival Sponsors</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <% sponsors.forEach((sponsor, index) => { %>
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-2 border rounded">
                                        <% if (sponsor.logoUrl) { %>
                                            <img src="<%= sponsor.logoUrl %>" alt="<%= sponsor.sponsorName %> Logo" 
                                                 class="me-3" style="height: 40px; width: auto; max-width: 60px; object-fit: contain;">
                                        <% } else { %>
                                            <div class="me-3 d-flex align-items-center justify-content-center bg-light border rounded" 
                                                 style="height: 40px; width: 60px; min-width: 60px;">
                                                <i class="bi bi-building text-muted"></i>
                                            </div>
                                        <% } %>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <a href="/carnivals/<%= carnival.id %>/sponsors/<%= sponsor.id %>" class="text-decoration-none">
                                                    <%= sponsor.sponsorName %>
                                                </a>
                                            </h6>
                                            <% if (sponsor.sponsorshipLevel) { %>
                                                <span class="badge bg-secondary small"><%= sponsor.sponsorshipLevel %></span>
                                            <% } %>
                                            <% if (sponsor.businessType) { %>
                                                <div class="text-muted small"><%= sponsor.businessType %></div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Contact Information -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Contact Information</h5>
                </div>
                <div class="card-body">
                    <% if (!carnival.isActive && !canManage) { %>
                        <!-- Obfuscated contact info for inactive carnivals -->
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-1"></i>
                            <small>Contact details are hidden for inactive carnivals.</small>
                        </div>
                        <div class="mb-3">
                            <strong>Organiser:</strong><br>
                            <%= carnival.organiserContactName || 'TBC' %>
                        </div>
                        <div class="mb-3">
                            <strong>Email:</strong><br>
                            <span class="text-muted"><%= carnival.organiserContactEmail %></span>
                        </div>
                        <div class="mb-3">
                            <strong>Phone:</strong><br>
                            <span class="text-muted"><%= carnival.organiserContactPhone  %></span>
                        </div>
                    <% } else { %>
                        <!-- Full contact info for active carnivals or carnival managers -->
                        <div class="mb-3">
                            <strong>Organiser:</strong><br>
                            <%= carnival.organiserContactName || 'TBC'  %>
                        </div>
                        <div class="mb-3">
                            <strong>Email:</strong><br>
                            <a href="mailto:<%= carnival.organiserContactEmail %>?subject=Enquiry about <%= carnival.title %>">
                                <%= carnival.organiserContactEmail  %>
                            </a>
                        </div>
                        <div class="mb-3">
                            <strong>Phone:</strong><br>
                            <a href="tel:<%= carnival.organiserContactPhone %>">
                                <%= carnival.organiserContactPhone  %>
                            </a>
                        </div>
                        
                        <!-- Social Media Links in Contact Information -->
                        <% if (carnival.socialMediaFacebook || carnival.socialMediaInstagram || carnival.socialMediaTwitter || carnival.socialMediaWebsite) { %>
                            <div class="mb-3">
                                <strong>Follow Us:</strong><br>
                                <div class="social-links mt-2">
                                    <% if (carnival.socialMediaFacebook) { %>
                                        <a href="<%= carnival.socialMediaFacebook %>" target="_blank" class="btn btn-facebook btn-sm me-2 mb-1">
                                            <i class="bi bi-facebook"></i> Facebook
                                        </a>
                                    <% } %>
                                    <% if (carnival.socialMediaInstagram) { %>
                                        <a href="<%= carnival.socialMediaInstagram %>" target="_blank" class="btn btn-instagram btn-sm me-2 mb-1">
                                            <i class="bi bi-instagram"></i> Instagram
                                        </a>
                                    <% } %>
                                    <% if (carnival.socialMediaTwitter) { %>
                                        <a href="<%= carnival.socialMediaTwitter %>" target="_blank" class="btn btn-twitter-x btn-sm me-2 mb-1">
                                            <i class="bi bi-twitter-x"></i> X (Twitter)
                                        </a>
                                    <% } %>
                                    <% if (carnival.socialMediaWebsite) { %>
                                        <a href="<%= carnival.socialMediaWebsite %>" target="_blank" class="btn-primary btn-sm me-2 mb-1">
                                            <i class="bi bi-globe"></i> Website
                                        </a>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                    <% } %>
                </div>
            </div>
            <!-- Club Registration Section (for delegates) -->
            <% if (user && canRegisterClub && carnival.isActive) { %>
                <% if (isRegistrationActive) { %>
                    <!-- Show registration form when registration is open -->
                    <div class="card shadow mb-4 border-success">
                        <div class="card-header bg-tertiary">
                            <h5 class="mb-0"><i class="bi bi-hand-thumbs-up"></i> Register Club Interest</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">Express your club's interest in attending this carnival. Your registration will be reviewed by the hosting club.</p>
                            
                            <!-- Registration Deadline Notice -->
                            <% if (carnival.registrationDeadline) { %>
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-calendar-check text-info"></i>
                                    <strong>Registration Deadline:</strong> <%= new Date(carnival.registrationDeadline).toLocaleDateString('en-AU', { 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    }) %>
                                </div>
                            <% } %>
                            
                            <!-- Registration Form -->
                            <form action="/carnivals/<%= carnival.id %>/register" method="POST" id="clubRegistrationForm">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="playerCount" class="form-label">Expected Player Count <span class="text-muted">(Optional)</span></label>
                                            <input type="number" class="form-control" id="playerCount" name="playerCount" 
                                                   min="0" max="100" placeholder="e.g. 15">
                                            <div class="form-text">Approximate number of players who might attend</div>
                                            <span class="text-muted">This is total number of players across all teams</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="numberOfTeams" class="form-label">Number of Teams</label>
                                            <input type="number" class="form-control" id="numberOfTeams" name="numberOfTeams" 
                                                   min="1" max="10" value="1" required>
                                            <div class="form-text">How many teams to register</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="teamName" class="form-label">Team Name</label>
                                    <input type="text" class="form-control" id="teamName" name="teamName" 
                                           value="<%= user && user.club ? user.club.clubName : '' %>" 
                                           maxlength="100" placeholder="Optional team name">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="contactPerson" class="form-label">Contact Person</label>
                                    <input type="text" class="form-control" id="contactPerson" name="contactPerson" 
                                           value="<%= user.firstName %> <%= user.lastName %>" maxlength="100">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="contactEmail" class="form-label">Contact Email</label>
                                    <input type="email" class="form-control" id="contactEmail" name="contactEmail" 
                                           value="<%= user.email %>">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="contactPhone" class="form-label">Contact Phone</label>
                                    <input type="tel" class="form-control" id="contactPhone" name="contactPhone" 
                                           value="<%= user.phoneNumber || '' %>" 
                                           maxlength="20" placeholder="Optional phone number">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="specialRequirements" class="form-label">Special Requirements</label>
                                    <textarea class="form-control" id="specialRequirements" name="specialRequirements" 
                                              rows="3" maxlength="500" placeholder="Any special requirements or notes..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-tertiary w-100">
                                    <i class="bi bi-hand-thumbs-up"></i> Register Interest
                                </button>
                            </form>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    Your interest registration will be reviewed by the hosting club. You'll be notified of their decision via email.
                                </small>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <!-- Show deadline closure message when registration is closed -->
                    <div class="card shadow mb-4 border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-clock"></i> Club Registration Closed</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">
                                <strong>Club registration for this carnival is now closed.</strong>
                            </p>
                            <% if (carnival.registrationDeadline) { %>
                                <p class="mb-0">
                                    <i class="bi bi-calendar-x text-warning"></i>
                                    Registration deadline was: <strong><%= new Date(carnival.registrationDeadline).toLocaleDateString('en-AU', { 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    }) %></strong>
                                </p>
                            <% } %>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    If you need to register your club, please contact the carnival organiser directly.
                                </small>
                            </div>
                        </div>
                    </div>
                <% } %>
            <% } else if (user && userClubRegistration && carnival.isActive) { %>
                <!-- Show registration status for already registered clubs -->
                <div class="card shadow mb-4 border-info">
                    <div class="card-header bg-info text-primary">
                        <h5 class="mb-0">
                            <% if (userClubRegistration.approvalStatus === 'approved') { %>
                                <i class="bi bi-check-circle bg-success"></i> Your Club is Registered
                            <% } else if (userClubRegistration.approvalStatus === 'pending') { %>
                                <i class="bi bi-clock  bg-warning"></i> Interest Registered
                            <% } else { %>
                                <i class="bi bi-x-circle"></i> Registration Status
                            <% } %>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Registration Status:</strong>
                            <% if (userClubRegistration.approvalStatus === 'approved') { %>
                                <span class="badge bg-success ms-2">
                                    <i class="bi bi-check-circle"></i> Approved
                                </span>
                                <% if (userClubRegistration.isPaid) { %>
                                    <span class="badge bg-success text-dark ms-1">Paid</span>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark ms-1">Payment Pending</span>
                                <% } %>
                            <% } else if (userClubRegistration.approvalStatus === 'pending') { %>
                                <span class="badge bg-warning text-dark ms-2">
                                    <i class="bi bi-clock"></i> Awaiting Review
                                </span>
                            <% } else if (userClubRegistration.approvalStatus === 'rejected') { %>
                                <span class="badge bg-danger ms-2">
                                    <i class="bi bi-x-circle"></i> Not Approved
                                </span>
                            <% } %>
                        </div>

                        <!-- Show different content based on approval status -->
                        <% if (userClubRegistration.approvalStatus === 'pending') { %>
                            <div class="alert alert-warning">
                                <i class="bi bi-clock me-2"></i>
                                <strong>Interest Registered</strong><br>
                                Your interest in attending this carnival has been registered and is awaiting review by the hosting club. 
                                You'll receive an email notification once your registration is reviewed.
                            </div>
                        <% } else if (userClubRegistration.approvalStatus === 'rejected') { %>
                            <div class="alert alert-danger">
                                <i class="bi bi-x-circle me-2"></i>
                                <strong>Interest Not Approved</strong><br>
                                Unfortunately, your interest registration was not approved by the hosting club.
                                <% if (userClubRegistration.rejectionReason) { %>
                                    <br><strong>Reason:</strong> <%= userClubRegistration.rejectionReason %>
                                <% } %>
                                <br>Contact the organiser if you have questions.
                            </div>
                        <% } else if (userClubRegistration.approvalStatus === 'approved') { %>
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <strong>Registration Approved!</strong><br>
                                Your club's interest has been approved and you're now registered to attend. 
                                <% if (!userClubRegistration.isPaid) { %>
                                    The organiser will contact you with payment details.
                                <% } %>
                            </div>
                        <% } %>
                        
                        <% if (userClubRegistration.playerCount) { %>
                            <div class="mb-2">
                                <strong>Expected Players:</strong> <%= userClubRegistration.playerCount %>
                            </div>
                        <% } %>
                        
                        <% if (userClubRegistration.teamName) { %>
                            <div class="mb-2">
                                <strong>Team Name:</strong> <%= userClubRegistration.teamName %>
                            </div>
                        <% } %>
                        
                        <% if (userClubRegistration.contactPerson) { %>
                            <div class="mb-2">
                                <strong>Contact:</strong> <%= userClubRegistration.contactPerson %>
                            </div>
                        <% } %>
                        
                        <% if (userClubRegistration.registrationDate) { %>
                            <div class="mb-3">
                                <strong>Interest Registered:</strong> <%= new Date(userClubRegistration.registrationDate).toLocaleDateString('en-AU') %>
                            </div>
                        <% } %>
                        
                        <!-- Player Management Button (only for approved registrations) -->
                        <% if (userClubRegistration.approvalStatus === 'approved') { %>
                            <div class="mb-3">
                                <a href="/carnivals/<%= carnival.id %>/register/players" class="btn btn-primary btn-sm w-100">
                                    <i class="bi bi-people"></i> Manage Players
                                </a>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> 
                                        Select which players from your club will attend this carnival.
                                    </small>
                                </div>
                            </div>
                        <% } %>
                        
                        <!-- Allow withdrawal/removal based on status -->
                        <% if (userClubRegistration.approvalStatus === 'pending' || (userClubRegistration.approvalStatus === 'approved' && !userClubRegistration.isPaid) || userClubRegistration.approvalStatus === 'rejected') { %>
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                                    data-action="unregister-carnival">
                                <i class="bi bi-x-circle"></i> 
                                <% if (userClubRegistration.approvalStatus === 'rejected') { %>
                                    Remove Registration
                                <% } else if (userClubRegistration.approvalStatus === 'pending') { %>
                                    Withdraw Interest
                                <% } else { %>
                                    Unregister My Club
                                <% } %>
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <% if (userClubRegistration.approvalStatus === 'pending') { %>
                                        You can withdraw your interest registration while it's being reviewed.
                                    <% } else if (userClubRegistration.approvalStatus === 'rejected') { %>
                                        Remove this declined registration from your records.
                                    <% } else { %>
                                        You can unregister before payment is made.
                                    <% } %>
                                </small>
                            </div>
                        <% } else if (userClubRegistration.approvalStatus === 'approved' && userClubRegistration.isPaid) { %>
                            <div class="alert alert-success mb-0">
                                <small>
                                    <i class="bi bi-success-circle"></i> 
                                    Contact the organiser to make changes after payment.
                                </small>
                            </div>
                        <% } %>
                    </div>
                </div>
            <% } else if (user && !user.clubId) { %>
                <!-- Message for users without a club -->
                <div class="card shadow mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Club Registration</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">To register interest for carnivals, you need to be associated with a club.</p>
                        <a href="/clubs" class="btn btn-primary btn-sm">
                            <i class="bi bi-search"></i> Find Your Club
                        </a>
                        <div class="mt-3">
                            <small class="text-muted">
                                Contact your club delegate to get added to your club's member list.
                            </small>
                        </div>
                    </div>
                </div>
            <% } else if (!user && carnival.isActive) { %>
                <!-- Message for non-logged in users -->
                <div class="card shadow mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-hand-thumbs-up"></i> Register Club Interest</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">Express your club's interest in attending this carnival. Your registration will be reviewed by the hosting club.</p>
                        
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>To register for a carnival, you will need an active club on this platform.</strong> 
                            Please log in or create your account to get started.
                        </div>

                        <div class="d-flex gap-3 flex-wrap">
                            <a href="/login" class="btn btn-primary">
                                <i class="bi bi-box-arrow-in-right me-2"></i>Log In
                            </a>
                            <a href="/register" class="btn btn-outline-primary">
                                <i class="bi bi-person-plus me-2"></i>Create Account
                            </a>
                        </div>

                        <div class="mt-4">
                            <h6><i class="bi bi-question-circle me-1"></i> Don't have a club on the platform yet?</h6>
                            <p class="small text-muted mb-3">
                                Once you create an account, you can either join an existing club or create a new club profile.
                            </p>
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="/clubs" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-search me-1"></i>Browse Existing Clubs
                                </a>
                                <% if (user && (user.isAdmin || user.isPrimaryDelegate)) { %>
                                    <a href="/clubs/create-on-behalf" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-plus-circle me-1"></i>Create Club on Behalf
                                    </a>
                                <% } else { %>
                                    <span class="btn btn-outline-secondary btn-sm disabled" title="Available after login">
                                        <i class="bi bi-plus-circle me-1"></i>Create New Club
                                    </span>
                                <% } %>
                            </div>
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-check me-1"></i>
                                Creating an account is free and helps clubs connect for Masters Rugby League carnivals across Australia.
                            </small>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Full-width Footer Section -->
<div class="carnival-footer bg-light border-top mt-4">
    <div class="container py-4">
        <div class="row">
            <div class="col-md-6">
                <h5 class="text-primary mb-3">Carnival Summary</h5>
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-calendar3 text-primary me-2"></i>
                    <span>
                        <% if (carnival.date && carnival.date instanceof Date && !isNaN(carnival.date)) { %>
                            <%= carnival.date.toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                        <% } else { %>
                            Date To Be Announced
                        <% } %>
                    </span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-geo-alt text-primary me-2"></i>
                    <span><%= carnival.locationAddress %></span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-building text-primary me-2"></i>
                    <span>Hosted by <%= hostClub ? hostClub.clubName : 'Unknown' %></span>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="text-primary mb-3">Quick Actions</h5>
                <div class="d-flex flex-wrap gap-2">
                    <% if (carnival.registrationLink && isRegistrationActive) { %>
                        <% if (!carnival.isActive && !canManage) { %>
                            <!-- Disabled registration button for inactive carnivals -->
                            <button class="btn btn-sm btn-secondary" disabled>
                                <i class="bi bi-x-circle"></i> Registration Closed
                            </button>
                        <% } else { %>
                            <a href="<%= carnival.registrationLink %>" class="btn btn-sm btn-tertiary" target="_blank">
                                <i class="bi bi-person-plus"></i> Player Registration
                            </a>
                        <% } %>
                    <% } %>
                    
                    <% if (!carnival.isActive && !canManage) { %>
                        <!-- Disabled contact button for inactive carnivals -->
                        <button class="btn btn-sm btn-outline-secondary" disabled>
                            <i class="bi bi-envelope"></i> Contact Unavailable
                        </button>
                    <% } else { %>
                        <a href="mailto:<%= carnival.organiserContactEmail %>?subject=Enquiry about <%= carnival.title %>" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-envelope"></i> Contact
                        </a>
                    <% } %>
                    
                    <a href="/carnivals" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Find Carnivals
                    </a>
                    
                    <% if (carnival.isActive || canManage) { %>
                        <!-- Only show social media links for active carnivals or to managers -->
                        <% if (carnival.socialMediaFacebook) { %>
                            <a href="<%= carnival.socialMediaFacebook %>" target="_blank" class="btn btn-sm btn-facebook">
                                <i class="bi bi-facebook"></i>
                            </a>
                        <% } %>
                        <% if (carnival.socialMediaInstagram) { %>
                            <a href="<%= carnival.socialMediaInstagram %>" target="_blank" class="btn btn-sm btn-instagram">
                                <i class="bi bi-instagram"></i>
                            </a>
                        <% } %>
                        <% if (carnival.socialMediaWebsite) { %>
                            <a href="<%= carnival.socialMediaWebsite %>" target="_blank" class="btn-primary btn-sm">
                                <i class="bi bi-globe"></i>
                            </a>
                        <% } %>
                    <% } %>
                </div>

                <!-- Admin Actions for Carnival Owners -->
                <% if (canEditCarnival || canTakeOwnership) { %>
                    <div class="mt-3">
                        <h6 class="text-muted mb-2">Admin Actions</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <!-- Take Ownership button for unclaimed MySideline carnivals -->
                            <% if (canTakeOwnership) { %>
                                <form method="POST" action="/carnivals/<%= carnival.id %>/take-ownership" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-tertiary" 
                                            data-confirm="Are you sure you want to take ownership of this carnival for your club? This will allow you to manage and edit the carnival details.">
                                        <i class="bi bi-hand-thumbs-up"></i> Take Ownership
                                    </button>
                                </form>
                            <% } %>

                            <!-- Edit for owners -->
                            <% if (canEditCarnival) { %>
                                <a href="/carnivals/<%= carnival.id %>/attendees" class="btn btn-sm btn-primary">
                                    <i class="bi bi-people"></i> Manage Attendees
                                </a>
                                
                                <!-- View All Players button (only if there are attendee clubs) -->
                                <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                                    <a href="/carnivals/<%= carnival.id %>/players" class="btn btn-sm btn-primary">
                                        <i class="bi bi-list-ul"></i> View All Players
                                    </a>
                                <% } %>
                                
                                <!-- Email Attendees button (only if there are attendee clubs) -->
                                <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#emailAttendeesModal">
                                        <i class="bi bi-envelope"></i> Email Attendees
                                    </button>
                                <% } %>
                                
                                <a href="/carnivals/<%= carnival.id %>/edit" class="btn btn-sm btn-outline-tertiary">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                            <% } %>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
        
        <!-- Optional: Add a divider and additional footer content -->
        <hr class="my-4">
        <div class="row">
            <div class="col-12 text-center text-muted">
                <small>
                    Carnival details are provided by the hosting club. For questions or corrections, please contact the organiser.
                    <br>
                    <strong>Carnival ID:</strong> <%= carnival.id %> | 
                    <strong>Last Updated:</strong> <%= new Date(carnival.updatedAt).toLocaleDateString('en-AU') %>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Claim Ownership Modal -->
<div class="modal fade" id="claimOwnershipModal" tabindex="-1" aria-labelledby="claimOwnershipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="claimOwnershipModalLabel">
                    <i class="bi bi-hand-thumbs-up text-warning me-2"></i>
                    Claim Carnival Ownership
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>What does claiming ownership mean?</strong>
                </div>
                
                <p>By claiming ownership of this MySideline carnival, you will:</p>
                
                <ul class="mb-3">
                    <li><strong>Gain full control</strong> - Edit carnival details, contact information, and scheduling</li>
                    <li><strong>Manage attendees</strong> - Add, remove, and communicate with registered clubs</li>
                    <li><strong>Update information</strong> - Keep carnival details current and accurate</li>
                    <li><strong>Handle registrations</strong> - Manage the registration process for your carnival</li>
                </ul>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Once you claim ownership, you become responsible for managing this carnival. 
                    This action cannot be undone without administrator assistance.
                </div>
                
                <p class="mb-0">
                    <strong>Current Carnival:</strong> <%= carnival.title %><br>
                    <strong>Your Club:</strong> <%= user && user.club ? user.club.clubName : 'Your Club' %>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <form method="POST" action="/carnivals/<%= carnival.id %>/take-ownership" class="d-inline">
                    <button type="submit" class="btn btn-tertiary">
                        <i class="bi bi-hand-thumbs-up"></i> Yes, Claim This Carnival
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Release Ownership Modal -->
<div class="modal fade" id="releaseOwnershipModal" tabindex="-1" aria-labelledby="releaseOwnershipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="releaseOwnershipModalLabel">
                    <i class="bi bi-unlock text-danger me-2"></i>
                    Release Carnival Ownership
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Releasing ownership will remove your access to manage this carnival.
                </div>
                
                <p class="mb-0">
                    <strong>Carnival:</strong> <%= carnival.title %><br>
                    <strong>Your Club:</strong> <%= user && user.club ? user.club.clubName : 'Your Club' %>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <form method="POST" action="/carnivals/<%= carnival.id %>/release-ownership" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-unlock"></i> Yes, Release Ownership
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Merge Carnival Modal -->
<% if (canMergeCarnival) { %>
<div class="modal fade" id="mergeCarnivalModal" tabindex="-1" aria-labelledby="mergeCarnivalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mergeCarnivalModalLabel">
                    <i class="bi bi-arrow-down-up text-info me-2"></i>
                    Merge Carnival
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>What does merging mean?</strong>
                </div>
                
                <p>Merging this MySideline carnival will:</p>
                
                <ul class="mb-3">
                    <li><strong>Copy MySideline data</strong> - Registration link and MySideline fields will be copied to your selected carnival</li>
                    <li><strong>Fill empty fields</strong> - Any empty fields in your target carnival will be populated from this MySideline carnival</li>
                    <li><strong>Deactivate this carnival</strong> - This MySideline carnival will be marked as inactive</li>
                    <li><strong>Preserve your data</strong> - Existing data in your target carnival will not be overwritten</li>
                </ul>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. Choose your target carnival carefully.
                </div>

                <form id="mergeCarnivalForm" method="POST" action="/carnivals/<%= carnival.id %>/merge">
                    <div class="mb-3">
                        <label for="targetCarnivalId" class="form-label">Select Target Carnival to Merge Into</label>
                        <select class="form-select" id="targetCarnivalId" name="targetCarnivalId" required>
                            <option value="">-- Select Carnival to Merge Into --</option>
                            <% availableMergeTargets.forEach(targetCarnival => { %>
                                <option value="<%= targetCarnival.id %>">
                                    <%= targetCarnival.title %> 
                                    <% if (targetCarnival.date) { %>
                                        - <%= new Date(targetCarnival.date).toLocaleDateString('en-AU') %>
                                    <% } %>
                                    <% if (targetCarnival.state) { %>
                                        (<%= targetCarnival.state %>)
                                    <% } %>
                                    <% if (user && user.isAdmin && targetCarnival.creator && targetCarnival.creator.club) { %>
                                        - Hosted by <%= targetCarnival.creator.club.clubName %>
                                    <% } %>
                                </option>
                            <% }); %>
                        </select>
                        <div class="form-text">
                            <% if (user && user.isAdmin) { %>
                                As an administrator, you can merge this MySideline carnival into any active carnival on the platform.
                            <% } else { %>
                                Select which of your existing carnivals you want to merge this MySideline carnival into.
                            <% } %>
                        </div>
                    </div>
                    
                    <% if (user && user.isAdmin) { %>
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-shield-exclamation me-2"></i>
                            <strong>Administrator Action:</strong> You are performing an administrative merge on behalf of other clubs. 
                            This will merge data between carnivals owned by different organizations.
                        </div>
                    <% } %>
                    
                    <div class="mb-3">
                        <p><strong>Source (MySideline):</strong> <%= carnival.title %></p>
                        <p><strong>Action:</strong> Data from this carnival will be merged into your selected carnival above, then this carnival will be deactivated.</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-info" onclick="confirmMerge()">
                    <i class="bi bi-arrow-down-up"></i> Proceed to Merge
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Merge Confirmation Modal -->
<div class="modal fade" id="mergeCarnivalConfirmModal" tabindex="-1" aria-labelledby="mergeCarnivalConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mergeCarnivalConfirmModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Confirm Carnival Merge
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Final Warning:</strong> This action cannot be undone!
                </div>
                
                <p>You are about to merge:</p>
                <ul>
                    <li><strong>Source:</strong> "<%= carnival.title %>" (MySideline Import)</li>
                    <li><strong>Target:</strong> <span id="targetCarnivalName">[Selected Carnival]</span></li>
                </ul>
                
                <p><strong>What will happen:</strong></p>
                <ul>
                    <li>MySideline data will be copied to your target carnival</li>
                    <li>Empty fields in target will be populated from source</li>
                    <li>This MySideline carnival will be deactivated</li>
                </ul>
                
                <p class="mb-0"><strong>Do you want to continue?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="submit" class="btn btn-danger" form="mergeCarnivalForm">
                    <i class="bi bi-arrow-down-up"></i> Yes, Merge Carnivals
                </button>
            </div>
        </div>
    </div>
</div>
<% } %>


<!-- Include external JavaScript files -->
<script type="module" src="/js/common-utils.js"></script>
<script type="module" src="/js/carnival-show.js"></script>

<!-- Help modal partial for carnival show page -->
<%- include('../partials/help-modal.ejs', { modalId: 'help-carnival-show' }) %>

<!-- Post-Creation Important Notices Modal -->
<% if (showPostCreationModal) { %>
<div class="modal fade" id="postCreationModal" tabindex="-1" aria-labelledby="postCreationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-tertiary text-white">
                <h5 class="modal-title" id="postCreationModalLabel">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    Carnival Created Successfully!
                </h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-success border-0 mb-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-party text-success me-3" style="font-size: 2rem;"></i>
                        <div>
                            <h5 class="mb-1">ðŸŽ‰ Great work!</h5>
                            <p class="mb-0">Your carnival "<strong><%= carnival.title %></strong>" has been created and is now live on the platform.</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <h6 class="text-danger mb-3">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Important Next Steps - Please Read Carefully
                        </h6>
                    </div>
                </div>

                <!-- NRL Registration Requirement -->
                <div class="card border-warning mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="bi bi-clipboard-check me-2"></i>
                            1. Official NRL Registration Required
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">
                            <strong>For all official NRL Masters competitions</strong>, you must also register your carnival 
                            with the National Rugby League through their official portal:
                        </p>
                        
                        <div class="d-grid gap-2 mb-3">
                            <a href="<%= process.env.PLAYNRL_REGISTRATION_URL || '#' %>" 
                               class="btn btn-tertiary" target="_blank" rel="noopener noreferrer">
                                <i class="bi bi-box-arrow-up-right me-2"></i>
                                Register Carnival with NRL Masters
                            </a>
                        </div>
                        
                        <div class="alert alert-info border-0 mb-0">
                            <small>
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Important:</strong> This platform complements the official NRL registration 
                                but does not replace the required NRL process for official competitions.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- MySideline Integration Notice -->
                <div class="card border-info mb-4">
                    <div class="card-header bg-info text-primary">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            2. MySideline Integration Notice
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">
                            <strong>Potential Duplicate Carnivals:</strong> MySideline may import a similar carnival that didn't 
                            automatically merge with your carnival. If this happens, you may need to manually merge the 
                            MySideline carnival with your carnival to avoid duplicates.
                        </p>
                        
                        <div class="alert alert-warning border-0 mb-0">
                            <small>
                                <i class="bi bi-gear me-1"></i>
                                <strong>What to expect:</strong> Our system attempts automatic matching, but manual review 
                                may be required for carnivals with different naming, dates, or locations. You'll be notified 
                                if merge options become available.
                            </small>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle me-2"></i>
                    Continue
                </button>
            </div>
        </div>
    </div>
</div>
<% } %>

<!-- Email Attendees Modal -->
<% if (user && carnival.attendingClubs && carnival.attendingClubs.length > 0 && 
       (canEditCarnival || 
        (user.clubId && carnival.attendingClubs.some(club => club.id === user.clubId)))) { %>
<div class="modal fade" id="emailAttendeesModal" tabindex="-1" aria-labelledby="emailAttendeesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailAttendeesModalLabel">
                    <i class="bi bi-envelope me-2"></i>
                    Email Attendee Clubs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="emailAttendeesForm" action="/carnivals/<%= carnival.id %>/email-attendees" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="text-muted">
                            Send a custom message to all attending clubs for "<%= carnival.title %>". 
                            This email will be sent to the primary contact for each club.
                        </p>
                    </div>

                    <!-- Recipients Info -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-people me-1"></i>
                            Recipients (<%= carnival.attendingClubs.length %> clubs)
                        </label>
                        <div class="border rounded p-2 bg-light">
                            <% carnival.attendingClubs.forEach((club, index) => { %>
                                <%= club.clubName %><% if (index < carnival.attendingClubs.length - 1) { %>, <% } %>
                            <% }); %>
                        </div>
                    </div>

                    <!-- Subject Field -->
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">
                            <i class="bi bi-tag me-1"></i>
                            Subject <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="emailSubject" 
                               name="subject" 
                               value="Update regarding <%= carnival.title %>"
                               required 
                               maxlength="200">
                        <div class="form-text">
                            Maximum 200 characters
                        </div>
                    </div>

                    <!-- Custom Message Field -->
                    <div class="mb-3">
                        <label for="customMessage" class="form-label">
                            <i class="bi bi-chat-text me-1"></i>
                            Your Message <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="customMessage" 
                                  name="customMessage" 
                                  rows="6" 
                                  required 
                                  maxlength="2000"
                                  placeholder="Enter your message to all attending clubs..."></textarea>
                        <div class="form-text d-flex justify-content-between">
                            <span>Maximum 2000 characters. This will be included in the email along with carnival details.</span>
                            <span class="char-counter text-muted">0/2000</span>
                        </div>
                    </div>

                    <!-- Preview Info -->
                    <div class="alert alert-info border-0">
                        <h6 class="alert-heading">
                            <i class="bi bi-info-circle me-1"></i>
                            Email Preview
                        </h6>
                        <p class="mb-1">
                            Your custom message will be included in a professional email template that also contains:
                        </p>
                        <ul class="mb-0">
                            <li>Carnival details (title, date, location)</li>
                            <li>Your contact information as the sender</li>
                            <li>Link to the carnival page</li>
                            <li>Standard email footer</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="sendEmailBtn">
                        <i class="bi bi-send me-1"></i>
                        Send Email to All Clubs
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<% } %>