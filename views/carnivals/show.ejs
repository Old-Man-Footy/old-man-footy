<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Hosting Club Banner -->
            <% if (carnival.creator && carnival.creator.club) { %>
                <div class="card shadow mb-4 border-primary">
                    <div class="card-body bg-light">
                        <div class="d-flex align-items-center">
                            <% 
                            // Show hosting club logo first, then fall back to carnival logo, then to missing.svg
                            const hostingLogoUrl = (carnival.creator && carnival.creator.club && carnival.creator.club.logoUrl) || carnival.clubLogoURL || '/icons/missing.svg';
                            %>
                            <img src="<%= hostingLogoUrl %>" alt="<%= carnival.creator.club.clubName %> Logo" 
                                 class="me-3" style="height: 60px; width: auto;">
                            <div class="flex-grow-1">
                                <h5 class="mb-1 text-primary">Hosted by</h5>
                                <h4 class="mb-2">
                                    <% if (carnival.creator.club.isPubliclyListed && carnival.creator.club.isActive) { %>
                                        <a href="/clubs/<%= carnival.creator.club.id %>" class="text-decoration-none text-primary">
                                            <%= carnival.creator.club.clubName %>
                                        </a>
                                    <% } else { %>
                                        <span class="<%= carnival.creator.club.isActive ? '' : 'club-inactive-label' %>">
                                            <%= carnival.creator.club.clubName %>
                                            <% if (!carnival.creator.club.isActive) { %>
                                                <span class="club-inactive-badge">Inactive</span>
                                            <% } %>
                                        </span>
                                    <% } %>
                                </h4>
                                <% if (carnival.creator.club.location) { %>
                                    <p class="mb-0 text-muted">
                                        <i class="bi bi-geo-alt me-1"></i><%= carnival.creator.club.location %>
                                        <% if (carnival.creator.club.state) { %>
                                            <span class="badge state-<%= carnival.creator.club.state.toLowerCase() %> ms-2"><%= carnival.creator.club.state %></span>
                                        <% } %>
                                    </p>
                                <% } %>
                            </div>
                            <% if (carnival.creator.club.isPubliclyListed && carnival.creator.club.isActive) { %>
                                <div>
                                    <a href="/clubs/<%= carnival.creator.club.id %>" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye me-1"></i>View Club Profile
                                    </a>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Main Carnival Information -->
            <div class="card shadow mb-4">
                <!-- Inactive Carnival Warning -->
                <% if (isInactiveCarnival && !canManage) { %>
                    <div class="alert alert-warning border-0 rounded-0 mb-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.25rem;"></i>
                            <div>
                                <strong>This carnival is no longer active.</strong><br>
                                <small>Contact details have been hidden and registration is no longer available. This information is kept for historical purposes.</small>
                            </div>
                        </div>
                    </div>
                <% } %>
                
                <% if (carnival.promotionalImageURL) { %>
                    <img src="<%= carnival.promotionalImageURL %>" class="card-img-top" 
                         alt="<%= carnival.title %>" style="height: 300px; object-fit: cover;">
                <% } %>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h3 mb-2"><%= carnival.title %></h1>
                            <div class="mb-2">
                                <span class="badge state-<%= carnival.state.toLowerCase() %> me-2"><%= carnival.state %></span>
                                <% if (!carnival.isActive) { %>
                                    <span class="badge bg-danger">Inactive</span>
                                <% } else if (carnival.date && carnival.date instanceof Date && !isNaN(carnival.date)) { %>
                                    <% if (carnival.date >= new Date()) { %>
                                        <span class="badge bg-success">Upcoming</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary">Past Event</span>
                                    <% } %>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark">Date TBA</span>
                                <% } %>
                                <% if (!carnival.isManuallyEntered && carnival.lastMySidelineSync) { %>
                                    <span class="badge bg-warning text-dark">MySideline Import</span>
                                <% } %>
                                <% if (canTakeOwnership) { %>
                                    <span class="badge bg-info">Available to Claim</span>
                                <% } %>
                            </div>
                        </div>
                        <% if (carnival.clubLogoURL) { %>
                            <% 
                            // Show carnival logo first, then fall back to hosting club logo, then to missing.svg
                            const carnivalLogoUrl = carnival.clubLogoURL || (carnival.creator && carnival.creator.club && carnival.creator.club.logoUrl) || '/icons/missing.svg';
                            %>
                            <img src="<%= carnivalLogoUrl %>" alt="Club Logo" 
                                 style="width: 80px; height: 80px; object-fit: contain;">
                        <% } else { %>
                            <% 
                            // No carnival logo, check for club logo, otherwise use missing.svg
                            const fallbackLogoUrl = (carnival.creator && carnival.creator.club && carnival.creator.club.logoUrl) || '/icons/missing.svg';
                            %>
                            <img src="<%= fallbackLogoUrl %>" alt="Club Logo" 
                                 style="width: 80px; height: 80px; object-fit: contain;">
                        <% } %>
                    </div>

                    <!-- Admin Actions Section -->
                    <% if ((user && carnival.createdByUserId && user.id === carnival.createdByUserId) || canTakeOwnership) { %>
                        <div class="alert alert-info mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-gear-fill me-2"></i>
                                    <strong>
                                        <% if (canTakeOwnership) { %>
                                            You can claim ownership of this MySideline event
                                        <% } else { %>
                                            You are the organizer of this event
                                        <% } %>
                                    </strong>
                                </div>
                                <div class="d-flex gap-2">
                                    <!-- Claim button for unclaimed MySideline events -->
                                    <% if (canTakeOwnership) { %>
                                        <button type="button" class="btn btn-warning btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#claimOwnershipModal">
                                            <i class="bi bi-hand-thumbs-up"></i> Claim Event
                                        </button>
                                    <% } %>

                                    
                                    <!-- Edit button for owners -->
                                    <% if (user && carnival.createdByUserId && user.id === carnival.createdByUserId) { %>
                                        <a href="/carnivals/<%= carnival.id %>/attendees" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-people"></i> Manage Attendees
                                        </a>

                                        <!-- View All Players button (only if there are attendee clubs) -->
                                        <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                                            <a href="/carnivals/<%= carnival.id %>/players" class="btn btn-outline-info btn-sm">
                                                <i class="bi bi-list-ul"></i> View All Players
                                            </a>
                                        <% } %>
                                        
                                        <a href="/carnivals/<%= carnival.id %>/edit" class="btn btn-outline-success btn-sm">
                                            <i class="bi bi-pencil"></i> Edit Event
                                        </a>

                                        <!-- Email Attendees button (only if there are attendee clubs) -->
                                        <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#emailAttendeesModal">
                                                <i class="bi bi-envelope"></i> Email Attendees
                                            </button>
                                        <% } %>
                                    <% } %>

                                    <!-- Release ownership button for MySideline events owned by the user -->
                                    <% if (user && carnival.createdByUserId && user.id === carnival.createdByUserId && carnival.lastMySidelineSync) { %>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#releaseOwnershipModal">
                                            <i class="bi bi-unlock"></i> Release Ownership
                                        </button>
                                    <% } %>

                                    <!-- Merge carnival button for MySideline events owned by the user -->
                                    <% if (canMergeCarnival) { %>
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#mergeCarnivalModal">
                                            <i class="bi bi-arrow-down-up"></i> Merge Carnival
                                        </button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% } %>

                    <!-- Key Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5><i class="bi bi-calendar3 text-primary"></i> Date & Time</h5>
                            <p class="mb-3">
                                <% if (carnival.date && carnival.date instanceof Date && !isNaN(carnival.date)) { %>
                                    <%= carnival.date.toLocaleDateString('en-AU', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    }) %>
                                <% } else { %>
                                    <span class="text-warning">Date To Be Announced</span>
                                <% } %>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="bi bi-geo-alt text-primary"></i> Location</h5>
                            <%- include('../partials/carnival-address', { 
                                carnival: carnival, 
                                addressClass: 'text-primary fw-semibold',
                                showIcon: false
                            }) %>
                        </div>
                    </div>

                    <!-- Schedule Details -->
                    <div class="mb-4">
                        <h5><i class="bi bi-clock text-primary"></i> Schedule Details</h5>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0" style="white-space: pre-line;"><%= carnival.scheduleDetails %></p>
                        </div>
                    </div>

                    <!-- Registration & Fees -->
                    <% if (carnival.registrationLink || carnival.feesDescription) { %>
                        <!-- Registration Section - Full Width -->
                        <% if (carnival.registrationLink) { %>
                            <div class="mb-4">
                                <h5><i class="bi bi-person-plus text-success"></i> Registration</h5>
                                <% if (!carnival.isActive) { %>
                                    <!-- Disabled registration for inactive carnivals (regardless of user permissions) -->
                                    <button class="btn btn-secondary" disabled>
                                        <i class="bi bi-x-circle"></i> Registration Closed
                                    </button>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Registration is no longer available for this carnival.
                                        </small>
                                    </div>
                                <% } else { %>
                                    <% 
                                    // Check if this is a MySideline link - show warning tooltip
                                    const isMySidelineEvent = carnival.registrationLink && 
                                        carnival.registrationLink.toLowerCase().includes('mysideline');
                                    const tooltipText = isMySidelineEvent ? 
                                        'MySideline links are not direct - you will need to follow the link and identify the exact carnival by name and date' : 
                                        'Click to register as a player for this carnival';
                                    %>
                                    <a href="<%= carnival.registrationLink %>" 
                                       class="btn btn-success" 
                                       target="_blank"
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top" 
                                       data-bs-title="<%= tooltipText %>"
                                       <% if (isMySidelineEvent) { %>data-bs-custom-class="carnival-mysideline-warning-tooltip"<% } %>>
                                        <i class="bi bi-box-arrow-up-right"></i> Register Now
                                        <% if (isMySidelineEvent) { %>
                                            <i class="bi bi-info-circle ms-1" style="font-size: 0.875rem;"></i>
                                        <% } %>
                                    </a>
                                    <% if (isMySidelineEvent) { %>
                                        <div class="mt-2">
                                            <small class="text-warning">
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                Registration via MySideline - manual navigation required
                                            </small>
                                        </div>
                                    <% } %>
                                <% } %>
                            </div>
                        <% } %>
                        
                        <!-- Fees Section - Full Width -->
                        <% if (carnival.feesDescription) { %>
                            <div class="mb-4">
                                <h5><i class="bi bi-currency-dollar text-info"></i> Fees</h5>
                                <p><%= carnival.feesDescription %></p>
                            </div>
                        <% } %>
                    <% } %>

                    <!-- Volunteers -->
                    <% if (carnival.callForVolunteers) { %>
                        <div class="mb-4">
                            <h5><i class="bi bi-hand-thumbs-up text-warning"></i> Volunteers Needed</h5>
                            <div class="alert alert-warning">
                                <p class="mb-0"><%= carnival.callForVolunteers %></p>
                            </div>
                        </div>
                    <% } %>

                    <!-- Draw Information -->
                    <% if (carnival.drawFileURL) { %>
                        <div class="draw-section">
                            <h5><i class="bi bi-trophy text-warning"></i> Draw & Results</h5>
                            <% if (carnival.drawTitle) { %>
                                <h6><%= carnival.drawTitle %></h6>
                            <% } %>
                            <% if (carnival.drawDescription) { %>
                                <p><%= carnival.drawDescription %></p>
                            <% } %>
                            <a href="<%= carnival.drawFileURL %>" class="btn btn-outline-info" target="_blank">
                                <i class="bi bi-download"></i> Download Draw
                                <% if (carnival.drawFileName) { %>
                                    (<%= carnival.drawFileName %>)
                                <% } %>
                            </a>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Attending Clubs Section -->
            <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                <div class="card shadow mb-4">
                    <div class="card-header bg-info">
                        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Attending Clubs</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <% carnival.attendingClubs.forEach((club, index) => { %>
                                <div class="col-lg-6 col-md-6 col-sm-12">
                                    <div class="d-flex align-items-center p-4 border rounded bg-light h-100">
                                        <% if (club.logoUrl) { %>
                                            <img src="<%= club.logoUrl %>" alt="<%= club.clubName %> Logo" 
                                                 class="me-3" style="height: 60px; width: auto; max-width: 80px; object-fit: contain;">
                                        <% } else { %>
                                            <div class="me-3 d-flex align-items-center justify-content-center bg-white border rounded" 
                                                 style="height: 60px; width: 80px; min-width: 80px;">
                                                <i class="bi bi-shield text-muted" style="font-size: 1.5rem;"></i>
                                            </div>
                                        <% } %>
                                        <div class="flex-grow-1">
                                            <% if (club.isPubliclyListed && club.isActive) { %>
                                                <a href="/clubs/<%= club.id %>" class="text-decoration-none fw-bold h6 mb-1 d-block">
                                                    <%= club.clubName %>
                                                </a>
                                            <% } else { %>
                                                <span class="fw-bold h6 mb-1 d-block">
                                                    <%= club.clubName %>
                                                    <% if (!club.isActive) { %>
                                                        <span class="badge bg-secondary ms-2">Inactive</span>
                                                    <% } %>
                                                </span>
                                            <% } %>
                                            <% if (club.state) { %>
                                                <div class="text-muted"><%= club.state %></div>
                                            <% } %>
                                            <% if (club.location) { %>
                                                <div class="text-muted small"><%= club.location %></div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                        <% if ((user && carnival.createdByUserId && user.id === carnival.createdByUserId) || canTakeOwnership) { %>
                            <div class="text-center mt-4">
                                <a href="/carnivals/<%= carnival.id %>/attendees" class="btn btn-outline-info">
                                    <i class="bi bi-list-ul"></i> Manage Attendees
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
            <% } else if ((user && carnival.createdByUserId && user.id === carnival.createdByUserId) || canTakeOwnership) { %>
                <!-- Show empty state for carnival owners -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-info">
                        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Attending Clubs</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                        </div>
                        <h6 class="text-muted mb-3">No clubs registered yet</h6>
                        <p class="text-muted mb-4">Start building your carnival by adding the first attending club.</p>
                        <a href="/carnivals/<%= carnival.id %>/attendees" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add First Club
                        </a>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Sponsors Section -->
            <% if (sponsors && sponsors.length > 0) { %>
                <div class="card shadow mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-star-fill"></i> Event Sponsors</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <% sponsors.forEach((sponsor, index) => { %>
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-2 border rounded">
                                        <% if (sponsor.logoUrl) { %>
                                            <img src="<%= sponsor.logoUrl %>" alt="<%= sponsor.sponsorName %> Logo" 
                                                 class="me-3" style="height: 40px; width: auto; max-width: 60px; object-fit: contain;">
                                        <% } else { %>
                                            <div class="me-3 d-flex align-items-center justify-content-center bg-light border rounded" 
                                                 style="height: 40px; width: 60px; min-width: 60px;">
                                                <i class="bi bi-building text-muted"></i>
                                            </div>
                                        <% } %>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <a href="/sponsors/<%= sponsor.id %>" class="text-decoration-none">
                                                    <%= sponsor.sponsorName %>
                                                </a>
                                            </h6>
                                            <% if (sponsor.sponsorshipLevel) { %>
                                                <span class="badge bg-secondary small"><%= sponsor.sponsorshipLevel %></span>
                                            <% } %>
                                            <% if (sponsor.businessType) { %>
                                                <div class="text-muted small"><%= sponsor.businessType %></div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Contact Information -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Contact Information</h5>
                </div>
                <div class="card-body">
                    <% if (!carnival.isActive && !canManage) { %>
                        <!-- Obfuscated contact info for inactive carnivals -->
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-1"></i>
                            <small>Contact details are hidden for inactive carnivals.</small>
                        </div>
                        <div class="mb-3">
                            <strong>Organiser:</strong><br>
                            <%= carnival.organiserContactName || 'TBC' %>
                        </div>
                        <div class="mb-3">
                            <strong>Email:</strong><br>
                            <span class="text-muted"><%= carnival.organiserContactEmail %></span>
                        </div>
                        <div class="mb-3">
                            <strong>Phone:</strong><br>
                            <span class="text-muted"><%= carnival.organiserContactPhone  %></span>
                        </div>
                    <% } else { %>
                        <!-- Full contact info for active carnivals or carnival managers -->
                        <div class="mb-3">
                            <strong>Organiser:</strong><br>
                            <%= carnival.organiserContactName || 'TBC'  %>
                        </div>
                        <div class="mb-3">
                            <strong>Email:</strong><br>
                            <a href="mailto:<%= carnival.organiserContactEmail %>?subject=Enquiry about <%= carnival.title %>">
                                <%= carnival.organiserContactEmail  %>
                            </a>
                        </div>
                        <div class="mb-3">
                            <strong>Phone:</strong><br>
                            <a href="tel:<%= carnival.organiserContactPhone %>">
                                <%= carnival.organiserContactPhone  %>
                            </a>
                        </div>
                        
                        <!-- Social Media Links in Contact Information -->
                        <% if (carnival.socialMediaFacebook || carnival.socialMediaInstagram || carnival.socialMediaTwitter || carnival.socialMediaWebsite) { %>
                            <div class="mb-3">
                                <strong>Follow Us:</strong><br>
                                <div class="social-links mt-2">
                                    <% if (carnival.socialMediaFacebook) { %>
                                        <a href="<%= carnival.socialMediaFacebook %>" target="_blank" class="btn btn-facebook btn-sm me-2 mb-1">
                                            <i class="bi bi-facebook"></i> Facebook
                                        </a>
                                    <% } %>
                                    <% if (carnival.socialMediaInstagram) { %>
                                        <a href="<%= carnival.socialMediaInstagram %>" target="_blank" class="btn btn-instagram btn-sm me-2 mb-1">
                                            <i class="bi bi-instagram"></i> Instagram
                                        </a>
                                    <% } %>
                                    <% if (carnival.socialMediaTwitter) { %>
                                        <a href="<%= carnival.socialMediaTwitter %>" target="_blank" class="btn btn-twitter-x btn-sm me-2 mb-1">
                                            <i class="bi bi-twitter-x"></i> X (Twitter)
                                        </a>
                                    <% } %>
                                    <% if (carnival.socialMediaWebsite) { %>
                                        <a href="<%= carnival.socialMediaWebsite %>" target="_blank" class="btn-primary btn-sm me-2 mb-1">
                                            <i class="bi bi-globe"></i> Website
                                        </a>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                    <% } %>
                </div>
            </div>
            <!-- Club Registration Section (for delegates) -->
            <% if (user && canRegisterClub && carnival.isActive) { %>
                <div class="card shadow mb-4 border-success">
                    <div class="card-header bg-success">
                        <h5 class="mb-0"><i class="bi bi-hand-thumbs-up"></i> Register Interest</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">Express your club's interest in attending this carnival. Your registration will be reviewed by the hosting club.</p>
                        
                        <!-- Registration Form -->
                        <form action="/carnivals/<%= carnival.id %>/register" method="POST" id="clubRegistrationForm">
                            <div class="mb-3">
                                <label for="playerCount" class="form-label">Expected Player Count</label>
                                <input type="number" class="form-control" id="playerCount" name="playerCount" 
                                       min="1" max="100" placeholder="e.g. 15">
                                <div class="form-text">Approximate number of players who might attend</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="teamName" class="form-label">Team Name</label>
                                <input type="text" class="form-control" id="teamName" name="teamName" 
                                       value="<%= user && user.club ? user.club.clubName : '' %>" 
                                       maxlength="100" placeholder="Optional team name">
                            </div>
                            
                            <div class="mb-3">
                                <label for="contactPerson" class="form-label">Contact Person</label>
                                <input type="text" class="form-control" id="contactPerson" name="contactPerson" 
                                       value="<%= user.firstName %> <%= user.lastName %>" maxlength="100">
                            </div>
                            
                            <div class="mb-3">
                                <label for="contactEmail" class="form-label">Contact Email</label>
                                <input type="email" class="form-control" id="contactEmail" name="contactEmail" 
                                       value="<%= user.email %>">
                            </div>
                            
                            <div class="mb-3">
                                <label for="contactPhone" class="form-label">Contact Phone</label>
                                <input type="tel" class="form-control" id="contactPhone" name="contactPhone" 
                                       value="<%= user.phoneNumber || '' %>" 
                                       maxlength="20" placeholder="Optional phone number">
                            </div>
                            
                            <div class="mb-3">
                                <label for="specialRequirements" class="form-label">Special Requirements</label>
                                <textarea class="form-control" id="specialRequirements" name="specialRequirements" 
                                          rows="3" maxlength="500" placeholder="Any special requirements or notes..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-hand-thumbs-up"></i> Register Interest
                            </button>
                        </form>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                Your interest registration will be reviewed by the hosting club. You'll be notified of their decision via email.
                            </small>
                        </div>
                    </div>
                </div>
            <% } else if (user && userClubRegistration && carnival.isActive) { %>
                <!-- Show registration status for already registered clubs -->
                <div class="card shadow mb-4 border-info">
                    <div class="card-header bg-info">
                        <h5 class="mb-0">
                            <% if (userClubRegistration.approvalStatus === 'approved') { %>
                                <i class="bi bi-check-circle"></i> Your Club is Registered
                            <% } else if (userClubRegistration.approvalStatus === 'pending') { %>
                                <i class="bi bi-clock"></i> Interest Registered
                            <% } else { %>
                                <i class="bi bi-x-circle"></i> Registration Status
                            <% } %>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Registration Status:</strong>
                            <% if (userClubRegistration.approvalStatus === 'approved') { %>
                                <span class="badge bg-success ms-2">
                                    <i class="bi bi-check-circle"></i> Approved
                                </span>
                                <% if (userClubRegistration.isPaid) { %>
                                    <span class="badge bg-info ms-1">Paid</span>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark ms-1">Payment Pending</span>
                                <% } %>
                            <% } else if (userClubRegistration.approvalStatus === 'pending') { %>
                                <span class="badge bg-warning text-dark ms-2">
                                    <i class="bi bi-clock"></i> Awaiting Review
                                </span>
                            <% } else if (userClubRegistration.approvalStatus === 'rejected') { %>
                                <span class="badge bg-danger ms-2">
                                    <i class="bi bi-x-circle"></i> Not Approved
                                </span>
                            <% } %>
                        </div>

                        <!-- Show different content based on approval status -->
                        <% if (userClubRegistration.approvalStatus === 'pending') { %>
                            <div class="alert alert-warning">
                                <i class="bi bi-clock me-2"></i>
                                <strong>Interest Registered</strong><br>
                                Your interest in attending this carnival has been registered and is awaiting review by the hosting club. 
                                You'll receive an email notification once your registration is reviewed.
                            </div>
                        <% } else if (userClubRegistration.approvalStatus === 'rejected') { %>
                            <div class="alert alert-danger">
                                <i class="bi bi-x-circle me-2"></i>
                                <strong>Interest Not Approved</strong><br>
                                Unfortunately, your interest registration was not approved by the hosting club.
                                <% if (userClubRegistration.rejectionReason) { %>
                                    <br><strong>Reason:</strong> <%= userClubRegistration.rejectionReason %>
                                <% } %>
                                <br>Contact the organiser if you have questions.
                            </div>
                        <% } else if (userClubRegistration.approvalStatus === 'approved') { %>
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <strong>Registration Approved!</strong><br>
                                Your club's interest has been approved and you're now registered to attend. 
                                <% if (!userClubRegistration.isPaid) { %>
                                    The organiser will contact you with payment details.
                                <% } %>
                            </div>
                        <% } %>
                        
                        <% if (userClubRegistration.playerCount) { %>
                            <div class="mb-2">
                                <strong>Expected Players:</strong> <%= userClubRegistration.playerCount %>
                            </div>
                        <% } %>
                        
                        <% if (userClubRegistration.teamName) { %>
                            <div class="mb-2">
                                <strong>Team Name:</strong> <%= userClubRegistration.teamName %>
                            </div>
                        <% } %>
                        
                        <% if (userClubRegistration.contactPerson) { %>
                            <div class="mb-2">
                                <strong>Contact:</strong> <%= userClubRegistration.contactPerson %>
                            </div>
                        <% } %>
                        
                        <% if (userClubRegistration.registrationDate) { %>
                            <div class="mb-3">
                                <strong>Interest Registered:</strong> <%= new Date(userClubRegistration.registrationDate).toLocaleDateString('en-AU') %>
                            </div>
                        <% } %>
                        
                        <!-- Player Management Button (only for approved registrations) -->
                        <% if (userClubRegistration.approvalStatus === 'approved') { %>
                            <div class="mb-3">
                                <a href="/carnivals/<%= carnival.id %>/register/players" class="btn btn-primary btn-sm w-100">
                                    <i class="bi bi-people"></i> Manage Players
                                </a>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> 
                                        Select which players from your club will attend this carnival.
                                    </small>
                                </div>
                            </div>
                        <% } %>
                        
                        <!-- Allow withdrawal/removal based on status -->
                        <% if (userClubRegistration.approvalStatus === 'pending' || (userClubRegistration.approvalStatus === 'approved' && !userClubRegistration.isPaid) || userClubRegistration.approvalStatus === 'rejected') { %>
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                                    data-action="unregister-carnival">
                                <i class="bi bi-x-circle"></i> 
                                <% if (userClubRegistration.approvalStatus === 'rejected') { %>
                                    Remove Registration
                                <% } else if (userClubRegistration.approvalStatus === 'pending') { %>
                                    Withdraw Interest
                                <% } else { %>
                                    Unregister My Club
                                <% } %>
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <% if (userClubRegistration.approvalStatus === 'pending') { %>
                                        You can withdraw your interest registration while it's being reviewed.
                                    <% } else if (userClubRegistration.approvalStatus === 'rejected') { %>
                                        Remove this declined registration from your records.
                                    <% } else { %>
                                        You can unregister before payment is made.
                                    <% } %>
                                </small>
                            </div>
                        <% } else if (userClubRegistration.approvalStatus === 'approved' && userClubRegistration.isPaid) { %>
                            <div class="alert alert-info mb-0">
                                <small>
                                    <i class="bi bi-info-circle"></i> 
                                    Contact the organiser to make changes after payment.
                                </small>
                            </div>
                        <% } %>
                    </div>
                </div>
            <% } else if (user && !user.clubId) { %>
                <!-- Message for users without a club -->
                <div class="card shadow mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Club Registration</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">To register interest for carnivals, you need to be associated with a club.</p>
                        <a href="/clubs" class="btn btn-primary btn-sm">
                            <i class="bi bi-search"></i> Find Your Club
                        </a>
                        <div class="mt-3">
                            <small class="text-muted">
                                Contact your club delegate to get added to your club's member list.
                            </small>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Full-width Footer Section -->
<div class="carnival-footer bg-light border-top mt-4">
    <div class="container py-4">
        <div class="row">
            <div class="col-md-6">
                <h5 class="text-primary mb-3">Event Summary</h5>
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-calendar3 text-primary me-2"></i>
                    <span>
                        <% if (carnival.date && carnival.date instanceof Date && !isNaN(carnival.date)) { %>
                            <%= carnival.date.toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                        <% } else { %>
                            Date To Be Announced
                        <% } %>
                    </span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-geo-alt text-primary me-2"></i>
                    <span><%= carnival.locationAddress %></span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-building text-primary me-2"></i>
                    <span>Hosted by <%= carnival.creator && carnival.creator.club ? carnival.creator.club.clubName : 'Unknown' %></span>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="text-primary mb-3">Quick Actions</h5>
                <div class="d-flex flex-wrap gap-2">
                    <% if (carnival.registrationLink) { %>
                        <% if (!carnival.isActive && !canManage) { %>
                            <!-- Disabled registration button for inactive carnivals -->
                            <button class="btn btn-sm btn-secondary" disabled>
                                <i class="bi bi-x-circle"></i> Registration Closed
                            </button>
                        <% } else { %>
                            <a href="<%= carnival.registrationLink %>" class="btn btn-sm btn-success" target="_blank">
                                <i class="bi bi-person-plus"></i> Register
                            </a>
                        <% } %>
                    <% } %>
                    
                    <% if (!carnival.isActive && !canManage) { %>
                        <!-- Disabled contact button for inactive carnivals -->
                        <button class="btn btn-sm btn-outline-secondary" disabled>
                            <i class="bi bi-envelope"></i> Contact Unavailable
                        </button>
                    <% } else { %>
                        <a href="mailto:<%= carnival.organiserContactEmail %>?subject=Enquiry about <%= carnival.title %>" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-envelope"></i> Contact
                        </a>
                    <% } %>
                    
                    <a href="/carnivals" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Find Carnivals
                    </a>
                    
                    <% if (carnival.isActive || canManage) { %>
                        <!-- Only show social media links for active carnivals or to managers -->
                        <% if (carnival.socialMediaFacebook) { %>
                            <a href="<%= carnival.socialMediaFacebook %>" target="_blank" class="btn btn-sm btn-facebook">
                                <i class="bi bi-facebook"></i>
                            </a>
                        <% } %>
                        <% if (carnival.socialMediaInstagram) { %>
                            <a href="<%= carnival.socialMediaInstagram %>" target="_blank" class="btn btn-sm btn-instagram">
                                <i class="bi bi-instagram"></i>
                            </a>
                        <% } %>
                        <% if (carnival.socialMediaWebsite) { %>
                            <a href="<%= carnival.socialMediaWebsite %>" target="_blank" class="btn-primary btn-sm">
                                <i class="bi bi-globe"></i>
                            </a>
                        <% } %>
                    <% } %>
                </div>

                <!-- Admin Actions for Event Owners -->
                <% if ((user && carnival.createdByUserId && user.id === carnival.createdByUserId) || canTakeOwnership) { %>
                    <div class="mt-3">
                        <h6 class="text-muted mb-2">Admin Actions</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <!-- Take Ownership button for unclaimed MySideline events -->
                            <% if (canTakeOwnership) { %>
                                <form method="POST" action="/carnivals/<%= carnival.id %>/take-ownership" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-warning" 
                                            data-confirm="Are you sure you want to take ownership of this event for your club? This will allow you to manage and edit the event details.">
                                        <i class="bi bi-hand-thumbs-up"></i> Take Ownership
                                    </button>
                                </form>
                            <% } %>

                            <!-- Edit for owners -->
                            <% if (user && carnival.createdByUserId && user.id === carnival.createdByUserId) { %>
                                <a href="/carnivals/<%= carnival.id %>/attendees" class="btn btn-sm btn-primary">
                                    <i class="bi bi-people"></i> Manage Attendees
                                </a>
                                
                                <!-- View All Players button (only if there are attendee clubs) -->
                                <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                                    <a href="/carnivals/<%= carnival.id %>/players" class="btn btn-sm btn-info">
                                        <i class="bi bi-list-ul"></i> View All Players
                                    </a>
                                <% } %>
                                
                                <!-- Email Attendees button (only if there are attendee clubs) -->
                                <% if (carnival.attendingClubs && carnival.attendingClubs.length > 0) { %>
                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#emailAttendeesModal">
                                        <i class="bi bi-envelope"></i> Email Attendees
                                    </button>
                                <% } %>
                                
                                <a href="/carnivals/<%= carnival.id %>/edit" class="btn btn-sm btn-outline-warning">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                            <% } %>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
        
        <!-- Optional: Add a divider and additional footer content -->
        <hr class="my-4">
        <div class="row">
            <div class="col-12 text-center text-muted">
                <small>
                    Event details are provided by the hosting club. For questions or corrections, please contact the organiser.
                    <br>
                    <strong>Event ID:</strong> <%= carnival.id %> | 
                    <strong>Last Updated:</strong> <%= new Date(carnival.updatedAt).toLocaleDateString('en-AU') %>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Claim Ownership Modal -->
<div class="modal fade" id="claimOwnershipModal" tabindex="-1" aria-labelledby="claimOwnershipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="claimOwnershipModalLabel">
                    <i class="bi bi-hand-thumbs-up text-warning me-2"></i>
                    Claim Event Ownership
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>What does claiming ownership mean?</strong>
                </div>
                
                <p>By claiming ownership of this MySideline event, you will:</p>
                
                <ul class="mb-3">
                    <li><strong>Gain full control</strong> - Edit event details, contact information, and scheduling</li>
                    <li><strong>Manage attendees</strong> - Add, remove, and communicate with registered clubs</li>
                    <li><strong>Update information</strong> - Keep event details current and accurate</li>
                    <li><strong>Handle registrations</strong> - Manage the registration process for your event</li>
                </ul>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Once you claim ownership, you become responsible for managing this event. 
                    This action cannot be undone without administrator assistance.
                </div>
                
                <p class="mb-0">
                    <strong>Current Event:</strong> <%= carnival.title %><br>
                    <strong>Your Club:</strong> <%= user && user.club ? user.club.clubName : 'Your Club' %>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <form method="POST" action="/carnivals/<%= carnival.id %>/take-ownership" class="d-inline">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-hand-thumbs-up"></i> Yes, Claim This Event
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Release Ownership Modal -->
<div class="modal fade" id="releaseOwnershipModal" tabindex="-1" aria-labelledby="releaseOwnershipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="releaseOwnershipModalLabel">
                    <i class="bi bi-unlock text-danger me-2"></i>
                    Release Event Ownership
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Releasing ownership will remove your access to manage this event.
                </div>
                
                <p class="mb-0">
                    <strong>Event:</strong> <%= carnival.title %><br>
                    <strong>Your Club:</strong> <%= user && user.club ? user.club.clubName : 'Your Club' %>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <form method="POST" action="/carnivals/<%= carnival.id %>/release-ownership" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-unlock"></i> Yes, Release Ownership
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Merge Carnival Modal -->
<% if (canMergeCarnival) { %>
<div class="modal fade" id="mergeCarnivalModal" tabindex="-1" aria-labelledby="mergeCarnivalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mergeCarnivalModalLabel">
                    <i class="bi bi-arrow-down-up text-info me-2"></i>
                    Merge Carnival
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>What does merging mean?</strong>
                </div>
                
                <p>Merging this MySideline carnival will:</p>
                
                <ul class="mb-3">
                    <li><strong>Copy MySideline data</strong> - Registration link and MySideline fields will be copied to your selected carnival</li>
                    <li><strong>Fill empty fields</strong> - Any empty fields in your target carnival will be populated from this MySideline event</li>
                    <li><strong>Deactivate this carnival</strong> - This MySideline carnival will be marked as inactive</li>
                    <li><strong>Preserve your data</strong> - Existing data in your target carnival will not be overwritten</li>
                </ul>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. Choose your target carnival carefully.
                </div>

                <form id="mergeCarnivalForm" method="POST" action="/carnivals/<%= carnival.id %>/merge">
                    <div class="mb-3">
                        <label for="targetCarnivalId" class="form-label">Select Target Carnival to Merge Into</label>
                        <select class="form-select" id="targetCarnivalId" name="targetCarnivalId" required>
                            <option value="">-- Select Carnival to Merge Into --</option>
                            <% availableMergeTargets.forEach(targetCarnival => { %>
                                <option value="<%= targetCarnival.id %>">
                                    <%= targetCarnival.title %> 
                                    <% if (targetCarnival.date) { %>
                                        - <%= new Date(targetCarnival.date).toLocaleDateString('en-AU') %>
                                    <% } %>
                                    <% if (targetCarnival.state) { %>
                                        (<%= targetCarnival.state %>)
                                    <% } %>
                                </option>
                            <% }); %>
                        </select>
                        <div class="form-text">
                            Select which of your existing carnivals you want to merge this MySideline event into.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p><strong>Source (MySideline):</strong> <%= carnival.title %></p>
                        <p><strong>Action:</strong> Data from this event will be merged into your selected carnival above, then this event will be deactivated.</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-info" onclick="confirmMerge()">
                    <i class="bi bi-arrow-down-up"></i> Proceed to Merge
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Merge Confirmation Modal -->
<div class="modal fade" id="mergeCarnivalConfirmModal" tabindex="-1" aria-labelledby="mergeCarnivalConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mergeCarnivalConfirmModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Confirm Carnival Merge
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Final Warning:</strong> This action cannot be undone!
                </div>
                
                <p>You are about to merge:</p>
                <ul>
                    <li><strong>Source:</strong> "<%= carnival.title %>" (MySideline Import)</li>
                    <li><strong>Target:</strong> <span id="targetCarnivalName">[Selected Carnival]</span></li>
                </ul>
                
                <p><strong>What will happen:</strong></p>
                <ul>
                    <li>MySideline data will be copied to your target carnival</li>
                    <li>Empty fields in target will be populated from source</li>
                    <li>This MySideline carnival will be deactivated</li>
                </ul>
                
                <p class="mb-0"><strong>Do you want to continue?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="submit" class="btn btn-danger" form="mergeCarnivalForm">
                    <i class="bi bi-arrow-down-up"></i> Yes, Merge Carnivals
                </button>
            </div>
        </div>
    </div>
</div>
<% } %>

<script>
function confirmMerge() {
    const targetSelect = document.getElementById('targetCarnivalId');
    const targetCarnivalName = document.getElementById('targetCarnivalName');
    
    if (!targetSelect.value) {
        alert('Please select a carnival to merge into.');
        return;
    }
    
    // Update confirmation modal with selected carnival name
    const selectedOption = targetSelect.options[targetSelect.selectedIndex];
    targetCarnivalName.textContent = selectedOption.text;
    
    // Hide first modal and show confirmation modal
    const firstModal = bootstrap.Modal.getInstance(document.getElementById('mergeCarnivalModal'));
    firstModal.hide();
    
    setTimeout(() => {
        const confirmModal = new bootstrap.Modal(document.getElementById('mergeCarnivalConfirmModal'));
        confirmModal.show();
    }, 300);
}
</script>

<!-- Include external JavaScript files -->
<script src="/js/common-utils.js"></script>
<script src="/js/carnival-show.js"></script>