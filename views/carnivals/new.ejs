<div class="container py-4" data-page-id="carnival-new">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary">
                    <h4 class="mb-0">
                        <i class="bi bi-plus-circle"></i> Add New Carnival
                    </h4>
                </div>
                <div class="card-body p-4">
                    <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
                        <% if (typeof duplicateWarning !== 'undefined' && duplicateWarning) { %>
                            <div class="alert alert-warning border-warning">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="bi bi-exclamation-triangle-fill fs-4 text-warning"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-2">Potential Duplicate Detected!</h6>
                                        <% errors.forEach(error => { %>
                                            <p class="mb-2"><%= error.msg %></p>
                                        <% }) %>
                                        <hr class="my-3">
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" class="btn btn-tertiary btn-sm" onclick="proceedAnyway()">
                                                <i class="bi bi-check-circle"></i> Create Anyway
                                            </button>
                                            <a href="/carnivals" class="btn btn-outline-secondary btn-sm">
                                                <i class="bi bi-search"></i> View Existing Carnivals
                                            </a>
                                            <button type="button" class="btn btn-outline-light btn-sm" onclick="clearForm()">
                                                <i class="bi bi-arrow-clockwise"></i> Start Over
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% } else { %>
                            <div class="alert alert-danger">
                                <% errors.forEach(error => { %>
                                    <p class="mb-0"><%= error.msg %></p>
                                <% }) %>
                            </div>
                        <% } %>
                    <% } %>

                    <!-- Information about MySideline integration -->
                    <div class="alert alert-info">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle-fill fs-5"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading mb-2">Smart Duplicate Prevention</h6>
                                <p class="mb-1">Our system automatically checks for similar events from MySideline to prevent duplicates.</p>
                                <small class="text-muted">However, for best results we recommend waiting until the MySideline carnival is live and has synced to OldManFooty. Once synced, you will be able to claim it on the carnival management page. This process ensures your data is merged with the imported carnival.</small>
                                <small class="text-muted">If your carnival is not NRL-affiliated, you can create a new carnival instead. Manual merge options are available if needed.</small>
                            </div>
                        </div>
                    </div>

                    <form method="POST" action="/carnivals/new" enctype="multipart/form-data" class="needs-validation" novalidate id="carnivalForm">
                        <!-- Hidden field to force creation when user chooses to proceed anyway -->
                        <input type="hidden" name="forceCreate" id="forceCreate" value="false">
                        
                        <!-- Basic Information -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Basic Information</h5>
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">
                                    Carnival Title *
                                    <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Use a descriptive name that includes the location and any special theme (e.g., 'Gold Coast Masters Carnival 2025')"></i>
                                    <!-- MySideline badge -->
                                    <% if (typeof importedFromMySideline !== 'undefined' && importedFromMySideline) { %>
                                        <span class="badge bg-secondary ms-2">Imported from MySideline</span>
                                    <% } %>
                                </label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       value="<%= typeof formData !== 'undefined' ? formData.title : '' %>" required>
                                <div class="invalid-feedback">Please provide a carnival title.</div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="date" class="form-label">
                                        <span id="dateLabel">Date *</span>
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Select the main carnival date. For multi-day events, use the first day."></i>
                                        <% if (typeof importedFromMySideline !== 'undefined' && importedFromMySideline) { %>
                                            <span class="badge bg-secondary ms-2">Imported from MySideline</span>
                                        <% } %>
                                    </label>
                                    <input type="date" class="form-control" id="date" name="date" 
                                           value="<%= typeof formData !== 'undefined' ? formData.date : '' %>" required>
                                    <div class="invalid-feedback">Please select a date.</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div id="endDateContainer" data-has-end-date="<%= typeof formData !== 'undefined' && formData.endDate ? 'true' : 'false' %>">
                                        <label for="endDate" class="form-label">End Date *</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate" 
                                               value="<%= typeof formData !== 'undefined' ? formData.endDate : '' %>">
                                        <div class="invalid-feedback">End date must be after start date.</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Multi-day carnival section -->
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="isMultiDay" name="isMultiDay" 
                                               <%= typeof formData !== 'undefined' && formData.endDate ? 'checked' : '' %>>
                                        <label class="form-check-label" for="isMultiDay">
                                            Multi-day carnival
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- State field -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="state" class="form-label">State *</label>
                                    <select class="form-select" id="state" name="state" required>
                                        <option value="">Select State</option>
                                        <% states.forEach(state => { %>
                                            <option value="<%= state %>" 
                                                    <%= typeof formData !== 'undefined' ? (formData.state === state ? 'selected' : '') : 
                                                        (user && user.club && user.club.state === state ? 'selected' : '') %>>
                                                <%= state %>
                                            </option>
                                        <% }) %>
                                    </select>
                                    <div class="invalid-feedback">Please select a state.</div>
                                    <% if (user && user.club && user.club.state) { %>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> Auto-populated from your club's state (<%= user.club.state %>)
                                        </div>
                                    <% } %>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="locationAddress" class="form-label">
                                    Location Address *
                                    <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="Include the venue name, street address, and any specific field information. Be as detailed as possible for participants to find the location."></i>
                                </label>
                                <textarea class="form-control" id="locationAddress" name="locationAddress" rows="2" required><%= typeof formData !== 'undefined' ? formData.locationAddress : '' %></textarea>
                                <div class="invalid-feedback">Please provide the location address.</div>
                            </div>

                            <!-- MySideline-Compatible Address Fields -->
                            <div class="mb-4">
                                <h6 class="text-secondary mb-3">
                                    <i class="bi bi-geo-alt"></i> Detailed Location Information
                                    <small class="text-muted">(Optional - for better mapping and MySideline compatibility)</small>
                                </h6>
                                
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="venueName" class="form-label">Venue Name</label>
                                        <input type="text" class="form-control" id="venueName" name="venueName" 
                                               value="<%= typeof formData !== 'undefined' ? formData.venueName : '' %>"
                                               placeholder="e.g., ANZ Stadium, Parramatta Sports Complex">
                                        <div class="form-text">Name of the venue or facility hosting the carnival</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="locationAddressLine1" class="form-label">Address Line 1</label>
                                        <input type="text" class="form-control" id="locationAddressLine1" name="locationAddressLine1" 
                                               value="<%= typeof formData !== 'undefined' ? formData.locationAddressLine1 : '' %>"
                                               placeholder="e.g., 123 Main Street">
                                        <div class="form-text">Street address or venue address</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="locationAddressLine2" class="form-label">Address Line 2</label>
                                        <input type="text" class="form-control" id="locationAddressLine2" name="locationAddressLine2" 
                                               value="<%= typeof formData !== 'undefined' ? formData.locationAddressLine2 : '' %>"
                                               placeholder="e.g., Suite 456, Building B">
                                        <div class="form-text">Additional address information (optional)</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="locationSuburb" class="form-label">Suburb/City</label>
                                        <input type="text" class="form-control" id="locationSuburb" name="locationSuburb" 
                                               value="<%= typeof formData !== 'undefined' ? formData.locationSuburb : '' %>"
                                               placeholder="e.g., Parramatta">
                                        <div class="form-text">The suburb or city where the carnival is held</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="locationPostcode" class="form-label">Postcode</label>
                                        <input type="text" class="form-control" id="locationPostcode" name="locationPostcode" 
                                               value="<%= typeof formData !== 'undefined' ? formData.locationPostcode : '' %>"
                                               placeholder="e.g., 2150" maxlength="10">
                                        <div class="form-text">Australian postcode</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="locationLatitude" class="form-label">Latitude</label>
                                        <input type="number" class="form-control" id="locationLatitude" name="locationLatitude" 
                                               value="<%= typeof formData !== 'undefined' ? formData.locationLatitude : '' %>"
                                               step="0.000001" min="-90" max="90"
                                               placeholder="e.g., -33.8568">
                                        <div class="form-text">GPS latitude coordinate (decimal degrees)</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="locationLongitude" class="form-label">Longitude</label>
                                        <input type="number" class="form-control" id="locationLongitude" name="locationLongitude" 
                                               value="<%= typeof formData !== 'undefined' ? formData.locationLongitude : '' %>"
                                               step="0.000001" min="-180" max="180"
                                               placeholder="e.g., 151.2153">
                                        <div class="form-text">GPS longitude coordinate (decimal degrees)</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="locationCountry" class="form-label">Country</label>
                                        <input type="text" class="form-control" id="locationCountry" name="locationCountry" 
                                               value="<%= typeof formData !== 'undefined' ? formData.locationCountry : 'Australia' %>"
                                               placeholder="Australia">
                                        <div class="form-text">Country where the carnival is held</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-flex align-items-center">
                                            <button type="button" class="btn btn-outline-info btn-sm" id="getLocationBtn">
                                                <i class="bi bi-geo"></i> Get GPS from Address
                                            </button>
                                            <small class="text-muted ms-2">Auto-fill coordinates from the main address</small>
                                        </div>
                                        <div class="form-text">&nbsp;</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Organiser Contact Information</h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="organiserContactName" class="form-label">Contact Name *</label>
                                    <input type="text" class="form-control" id="organiserContactName" name="organiserContactName" 
                                           value="<%= typeof formData !== 'undefined' ? formData.organiserContactName : user.firstName + ' ' + user.lastName %>" required>
                                    <div class="invalid-feedback">Please provide a contact name.</div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> Auto-populated with your name
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="organiserContactPhone" class="form-label">Contact Phone *</label>
                                    <input type="tel" class="form-control" id="organiserContactPhone" name="organiserContactPhone" 
                                           value="<%= typeof formData !== 'undefined' ? formData.organiserContactPhone : 
                                                    (user.phoneNumber || (user.club && user.club.contactPhone ? user.club.contactPhone : '')) %>" required>
                                    <div class="invalid-feedback">Please provide a contact phone number.</div>
                                    <% if ((user.phoneNumber || (user.club && user.club.contactPhone)) && typeof formData === 'undefined') { %>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> Auto-populated from your <%= user.phoneNumber ? 'profile' : 'club details' %>
                                        </div>
                                    <% } %>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="organiserContactEmail" class="form-label">
                                    Contact Email *
                                    <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                       title="This email will be visible to clubs and used for carnival-related communications."></i>
                                </label>
                                <input type="email" class="form-control" id="organiserContactEmail" name="organiserContactEmail" 
                                       value="<%= typeof formData !== 'undefined' ? formData.organiserContactEmail : 
                                                (user.email || (user.club && user.club.contactEmail ? user.club.contactEmail : '')) %>" required>
                                <div class="invalid-feedback">Please provide a valid contact email.</div>
                                <% if ((user.email || (user.club && user.club.contactEmail)) && typeof formData === 'undefined') { %>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> Auto-populated from your <%= user.email ? 'profile' : 'club details' %>
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Additional Information</h5>                           

                            <div class="mb-3">
                                <label for="feesDescription" class="form-label">Fees Description</label>
                                <textarea class="form-control" id="feesDescription" name="feesDescription" rows="2" 
                                          placeholder="Entry fees, payment methods, etc."><%= typeof formData !== 'undefined' ? formData.feesDescription : '' %></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="callForVolunteers" class="form-label">Call for Volunteers</label>
                                <textarea class="form-control" id="callForVolunteers" name="callForVolunteers" rows="2" 
                                          placeholder="Volunteer opportunities, requirements, contact details"><%= typeof formData !== 'undefined' ? formData.callForVolunteers : '' %></textarea>
                            </div>
                        </div>

                        <!-- Social Media Links -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Social Media Links</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="socialMediaFacebook" class="form-label">
                                        <i class="bi bi-facebook label-facebook"></i> Facebook
                                    </label>
                                    <input type="url" class="form-control" id="socialMediaFacebook" name="socialMediaFacebook" 
                                           value="<%= typeof formData !== 'undefined' ? formData.socialMediaFacebook : '' %>"
                                           placeholder="https://facebook.com/yourpage">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="socialMediaInstagram" class="form-label">
                                        <i class="bi bi-instagram label-instagram"></i> Instagram
                                    </label>
                                    <input type="url" class="form-control" id="socialMediaInstagram" name="socialMediaInstagram" 
                                           value="<%= typeof formData !== 'undefined' ? formData.socialMediaInstagram : '' %>"
                                           placeholder="https://instagram.com/yourpage">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="socialMediaTwitter" class="form-label">
                                        <i class="bi bi-twitter-x label-twitter-x"></i> X (Twitter)                                    </label>
                                    <input type="url" class="form-control" id="socialMediaTwitter" name="socialMediaTwitter" 
                                           value="<%= typeof formData !== 'undefined' ? formData.socialMediaTwitter : '' %>"
                                           placeholder="https://x.com/yourpage">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="socialMediaWebsite" class="form-label">
                                        <i class="bi bi-globe text-success"></i> Website
                                    </label>
                                    <input type="url" class="form-control" id="socialMediaWebsite" name="socialMediaWebsite" 
                                           value="<%= typeof formData !== 'undefined' ? formData.socialMediaWebsite : '' %>"
                                           placeholder="https://yourwebsite.com">
                                </div>
                            </div>
                        </div>

                        <!-- File Uploads -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Images & Documents</h5>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="clubLogo" class="form-label">Club Logo</label>
                                    <%- include('../partials/logo-uploader', {
                                        fieldName: 'logo',
                                        uploadText: 'Click or drag to upload club logo',
                                        maxFileSize: 'Max 10MB',
                                        acceptedFormats: 'JPG/PNG/SVG/GIF/WebP',
                                        helpText: 'Max 10MB, JPG/PNG/SVG/GIF/WebP'
                                    }) %>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="promotionalImage" class="form-label">Promotional Image</label>
                                    <div class="file-upload-area">
                                        <input type="file" class="form-control file-input-hidden" id="promotionalImage" name="promotionalImage" 
                                               accept="image/*">
                                        <i class="bi bi-image display-6 text-muted"></i>
                                        <p class="upload-text mt-2">Click or drag to upload promotional image</p>
                                        <small class="text-muted">Max 5MB, JPG/PNG only</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="drawFile" class="form-label">Draw Sheet</label>
                                    <div class="file-upload-area">
                                        <input type="file" class="form-control file-input-hidden" id="drawFile" name="drawFile" 
                                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                        <i class="bi bi-file-earmark-text display-6 text-muted"></i>
                                        <p class="upload-text mt-2">Click or drag to upload draw sheet</p>
                                        <small class="text-muted">Max 10MB, PDF/DOC/Image files</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Draw Information -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="drawTitle" class="form-label">Draw Title</label>
                                    <input type="text" class="form-control" id="drawTitle" name="drawTitle" 
                                           value="<%= typeof formData !== 'undefined' ? formData.drawTitle : '' %>"
                                           placeholder="e.g., Pool Draw, Finals Draw">
                                    <div class="form-text">Optional title for the draw sheet</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="drawDescription" class="form-label">Draw Description</label>
                                    <textarea class="form-control" id="drawDescription" name="drawDescription" rows="2" 
                                              placeholder="Brief description of the draw format or details"><%= typeof formData !== 'undefined' ? formData.drawDescription : '' %></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <a href="/dashboard" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Create Carnival
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module" src="/js/carnival-new.js"></script>
