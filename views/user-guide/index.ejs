<div class="user-guide-index container">
  <h1><%= title %></h1>
  <p class="lead">Select a guide page to view detailed instructions and a screenshot.</p>
  <% // safe defaults in case controller didn't pass the variables we expect %>
  <% const auth = !!(typeof isAuthenticated !== 'undefined' ? isAuthenticated : false); %>
  <% const allPages = Array.isArray(pages) ? pages : []; %>
  <% const publicPages = allPages.filter(p => !p.authRequired); %>
  <% const delegatePages = allPages.filter(p => p.authRequired); %>

  <% if (!auth) { %>
  <div class="row">
    <% publicPages.forEach(function(p) { %>
      <% const thumbUrl = p && p.screenshotUrl ? p.screenshotUrl : '/images/placeholder.png'; %>
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-header-thumb" style="background-image: url('<%= thumbUrl %>')"></div>
          <div class="card-body">
            <h5 class="card-title"><%= p.title %></h5>
            <p class="card-text text-muted"><%= p.description %></p>
            <% if (p.details && p.details.length) { %>
              <ul class="small">
                <% p.details.forEach(function(d) { %>
                  <li><%= d %></li>
                <% }); %>
              </ul>
            <% } %>
          </div>
          <div class="card-footer bg-transparent">
            <a href="/user-guide/<%= p.key %>" class="btn btn-primary">Open</a>
            <a href="<%= (p.url || '').replace(':id','51') %>" class="btn btn-link ms-2">Open live page</a>
          </div>
        </div>
      </div>
    <% }); %>
  </div>
  <% } %>

  <% if (auth) { %>
    <% if (delegatePages.length) { %>
      <div class="row">
        <% delegatePages.forEach(function(p) { %>
          <% const thumbUrl = p && p.screenshotUrl ? p.screenshotUrl : '/images/placeholder.png'; %>
          <div class="col-md-6 mb-3">
            <div class="card h-100 border-secondary">
              <div class="card-header-thumb" style="background-image: url('<%= thumbUrl %>')"></div>
              <div class="card-body">
                <h5 class="card-title"><%= p.title %> <span class="badge badge-delegate">Delegate</span></h5>
                <p class="card-text text-muted"><%= p.description %></p>
                <% if (p.details && p.details.length) { %>
                  <ul class="small">
                    <% p.details.forEach(function(d) { %>
                      <li><%= d %></li>
                    <% }); %>
                  </ul>
                <% } %>
              </div>
              <div class="card-footer bg-transparent">
                <a href="/user-guide/<%= p.key %>" class="btn btn-primary">Open</a>
                <a href="<%= (p.url || '').replace(':id','51') %>" class="btn btn-link ms-2">Open live page</a>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>
  <% } else if (delegatePages.length) { %>
    <div class="alert alert-info mt-4">
      Some guide pages are only available to logged-in delegates. <a href="/auth/login">Log in</a> to see full delegate instructions.
    </div>
  <% } %>
</div>
