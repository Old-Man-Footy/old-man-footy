<div class="container" data-page-id="admin-stats">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="admin-page-title">
                    <i class="bi bi-bar-chart text-info"></i>
                    System Statistics
                </h1>
                <div class="d-flex gap-2">
                    <a href="/admin/reports" class="btn btn-outline-light">
                        <i class="bi bi-file-earmark-text"></i> Full Reports
                    </a>
                    <a href="/admin/dashboard" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Period Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-range"></i> Report Period
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="/admin/reports" class="row g-3">
                        <div class="col-md-3">
                            <label for="period" class="form-label">Time Period</label>
                            <select class="form-select" id="period" name="period" data-period="<%= filters.period %>">
                                <option value="7" <%= filters.period === '7' ? 'selected' : '' %>>Last 7 days</option>
                                <option value="30" <%= filters.period === '30' ? 'selected' : '' %>>Last 30 days</option>
                                <option value="90" <%= filters.period === '90' ? 'selected' : '' %>>Last 3 months</option>
                                <option value="365" <%= filters.period === '365' ? 'selected' : '' %>>Last year</option>
                                <option value="custom" <%= filters.period === 'custom' ? 'selected' : '' %>>Custom range</option>
                            </select>
                        </div>
                        <div class="col-md-3 custom-date-group <%= filters.period === 'custom' ? 'd-block' : 'd-none' %>">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" 
                                   value="<%= filters.startDate || '' %>">
                        </div>
                        <div class="col-md-3 custom-date-group <%= filters.period === 'custom' ? 'd-block' : 'd-none' %>">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" 
                                   value="<%= filters.endDate || '' %>">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Update Report
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary h-100">
                <div class="card-body text-center">
                    <i class="bi bi-people fs-1 mb-3"></i>
                    <h3><%= stats.totalUsers %></h3>
                    <p class="mb-0">Total Users</p>
                    <small>+<%= stats.newUsers %> this period</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success h-100">
                <div class="card-body text-center">
                    <i class="bi bi-building fs-1 mb-3"></i>
                    <h3><%= stats.totalClubs %></h3>
                    <p class="mb-0">Total Clubs</p>
                    <small>+<%= stats.newClubs %> this period</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info h-100">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-event fs-1 mb-3"></i>
                    <h3><%= stats.totalCarnivals %></h3>
                    <p class="mb-0">Total Carnivals</p>
                    <small>+<%= stats.newCarnivals %> this period</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body text-center">
                    <i class="bi bi-award fs-1 mb-3"></i>
                    <h3><%= stats.totalSponsors %></h3>
                    <p class="mb-0">Total Sponsors</p>
                    <small>+<%= stats.newSponsors %> this period</small>
                </div>
            </div>
        </div>
    </div>

    <!-- User Activity -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-check"></i> User Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="p-3">
                                <h4 class="text-success"><%= stats.activeUsers %></h4>
                                <p class="mb-0">Active Users</p>
                                <small class="text-muted"><%= ((stats.activeUsers / stats.totalUsers) * 100).toFixed(1) %>% of total</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3">
                                <h4 class="text-warning"><%= stats.inactiveUsers %></h4>
                                <p class="mb-0">Inactive Users</p>
                                <small class="text-muted"><%= ((stats.inactiveUsers / stats.totalUsers) * 100).toFixed(1) %>% of total</small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="p-2">
                                <h5 class="text-danger"><%= stats.adminUsers %></h5>
                                <small>Administrators</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2">
                                <h5 class="text-primary"><%= stats.primaryDelegates %></h5>
                                <small>Primary Delegates</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2">
                                <h5 class="text-secondary"><%= stats.regularUsers %></h5>
                                <small>Regular Delegates</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-geo-alt"></i> Geographic Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <% if (stats.stateDistribution && stats.stateDistribution.length > 0) { %>
                        <% stats.stateDistribution.forEach(state => { %>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><%= state.state %></span>
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2 state-progress-bar" data-percent="<%= (state.count / stats.totalClubs * 100) %>">
                                        <div class="progress-bar"></div>
                                    </div>
                                    <small><%= state.count %> clubs</small>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p class="text-muted text-center">No geographic data available</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Carnival Statistics -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-event"></i> Carnival Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3 text-center">
                            <h4 class="text-info"><%= stats.upcomingCarnivals %></h4>
                            <small>Upcoming</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-success"><%= stats.activeCarnivals %></h4>
                            <small>Active</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-secondary"><%= stats.completedCarnivals %></h4>
                            <small>Completed</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-primary"><%= stats.averageAttendees %></h4>
                            <small>Avg. Attendees</small>
                        </div>
                    </div>
                    <hr>
                    <h6>Recent Carnival Activity</h6>
                    <% if (stats.recentCarnivals && stats.recentCarnivals.length > 0) { %>
                        <div class="list-group list-group-flush">
                            <% stats.recentCarnivals.forEach(carnival => { %>
                                <div class="list-group-item border-0 px-0">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong><%= carnival.title %></strong>
                                            <br>
                                            <small class="text-muted">
                                                <%= carnival.state %> â€¢ 
                                                <%= new Date(carnival.date).toLocaleDateString('en-AU') %>
                                            </small>
                                        </div>
                                        <span class="badge bg-primary"><%= carnival.attendeeCount %> attendees</span>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p class="text-muted">No recent carnival activity</p>
                    <% } %>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-envelope"></i> Email Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h4 class="text-info"><%= stats.totalSubscriptions %></h4>
                        <p class="mb-0">Email Subscriptions</p>
                        <small class="text-muted">+<%= stats.newSubscriptions %> this period</small>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="p-2">
                                <h5 class="text-success"><%= stats.emailsSent %></h5>
                                <small>Emails Sent</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2">
                                <h5 class="text-primary"><%= stats.invitationsSent %></h5>
                                <small>Invitations</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-heartbeat"></i> System Health & Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="text-center p-3 border rounded">
                                <i class="bi bi-database fs-3 text-primary"></i>
                                <h5 class="mt-2">Database</h5>
                                <span class="badge bg-primary">Healthy</span>
                                <br>
                                <small class="text-muted"><%= stats.dbSize %> records</small>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="text-center p-3 border rounded">
                                <i class="bi bi-cloud-upload fs-3 text-primary"></i>
                                <h5 class="mt-2">Storage</h5>
                                <span class="badge bg-primary">Normal</span>
                                <br>
                                <small class="text-muted"><%= stats.storageUsed %> used</small>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="text-center p-3 border rounded">
                                <i class="bi bi-shield-check fs-3 text-primary"></i>
                                <h5 class="mt-2">Security</h5>
                                <span class="badge bg-primary">Secure</span>
                                <br>
                                <small class="text-muted">No issues detected</small>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="text-center p-3 border rounded">
                                <i class="bi bi-speedometer2 fs-3 text-primary"></i>
                                <h5 class="mt-2">Performance</h5>
                                <span class="badge bg-primary">Good</span>
                                <br>
                                <small class="text-muted">Avg response: <%= stats.avgResponseTime %>ms</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-trophy"></i> Top Clubs by Activity
                    </h5>
                </div>
                <div class="card-body">
                    <% if (stats.topClubs && stats.topClubs.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Club</th>
                                        <th>Carnivals</th>
                                        <th>Members</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% stats.topClubs.forEach((club, index) => { %>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-secondary me-2"><%= index + 1 %></span>
                                                    <div>
                                                        <strong><%= club.clubName %></strong>
                                                        <br>
                                                        <small class="text-muted"><%= club.state %></small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><%= club.carnivalCount %></td>
                                            <td><%= club.memberCount %></td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <p class="text-muted text-center">No club activity data available</p>
                    <% } %>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-star"></i> Top Sponsors by Involvement
                    </h5>
                </div>
                <div class="card-body">
                    <% if (stats.topSponsors && stats.topSponsors.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Sponsor</th>
                                        <th>Clubs</th>
                                        <th>Carnivals</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% stats.topSponsors.forEach((sponsor, index) => { %>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-secondary me-2"><%= index + 1 %></span>
                                                    <strong><%= sponsor.sponsorName %></strong>
                                                </div>
                                            </td>
                                            <td><%= sponsor.clubCount %></td>
                                            <td><%= sponsor.carnivalCount %></td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <p class="text-muted text-center">No sponsor activity data available</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module" src="/js/admin-stats.js"></script>