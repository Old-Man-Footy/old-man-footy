<div class="container mt-4" data-page-id="admin-audit-logs">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-shield-check"></i> Audit Logs</h2>
                    <p class="text-muted mb-0">System security and activity monitoring</p>
                </div>
                <div>
                    <a href="/admin/audit-logs/export<%= Object.keys(filters).some(key => filters[key]) ? '?' + Object.entries(filters).filter(([key, value]) => value).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&') : '' %>" 
                       class="btn btn-outline-success">
                        <i class="bi bi-download"></i> Export CSV
                    </a>
                    <a href="/admin/dashboard" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel"></i> Filters
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="/admin/audit-logs">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label for="userId" class="form-label">User</label>
                                <select name="userId" id="userId" class="form-select">
                                    <option value="">All Users</option>
                                    <% users.forEach(user => { %>
                                        <option value="<%= user.id %>" <%= filters.userId == user.id ? 'selected' : '' %>>
                                            <%= user.firstName %> <%= user.lastName %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="action" class="form-label">Action</label>
                                <select name="action" id="action" class="form-select">
                                    <option value="">All Actions</option>
                                    <% actions.forEach(action => { %>
                                        <option value="<%= action %>" <%= filters.action === action ? 'selected' : '' %>>
                                            <%= action.replace(/_/g, ' ') %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="entityType" class="form-label">Entity Type</label>
                                <select name="entityType" id="entityType" class="form-select">
                                    <option value="">All Types</option>
                                    <% entityTypes.forEach(entityType => { %>
                                        <option value="<%= entityType %>" <%= filters.entityType === entityType ? 'selected' : '' %>>
                                            <%= entityType %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="result" class="form-label">Result</label>
                                <select name="result" id="result" class="form-select">
                                    <option value="">All Results</option>
                                    <option value="SUCCESS" <%= filters.result === 'SUCCESS' ? 'selected' : '' %>>Success</option>
                                    <option value="FAILURE" <%= filters.result === 'FAILURE' ? 'selected' : '' %>>Failure</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" name="startDate" id="startDate" class="form-control" value="<%= filters.startDate %>">
                            </div>
                            <div class="col-md-2">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" name="endDate" id="endDate" class="form-control" value="<%= filters.endDate %>">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Apply Filters
                                </button>
                                <a href="/admin/audit-logs" class="btn btn-outline-secondary ms-2">
                                    <i class="bi bi-arrow-clockwise"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Log Statistics -->
    <div class="row mb-4" id="audit-stats">
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <i class="bi bi-activity fs-2 text-primary"></i>
                    <h4 class="mt-2" id="total-actions">Loading...</h4>
                    <p class="mb-0">Total Actions</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <i class="bi bi-check-circle fs-2 text-success"></i>
                    <h4 class="mt-2" id="successful-actions">Loading...</h4>
                    <p class="mb-0">Successful</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <i class="bi bi-x-circle fs-2 text-danger"></i>
                    <h4 class="mt-2" id="failed-actions">Loading...</h4>
                    <p class="mb-0">Failed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <i class="bi bi-percent fs-2 text-info"></i>
                    <h4 class="mt-2" id="success-rate">Loading...</h4>
                    <p class="mb-0">Success Rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Logs Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul"></i> Audit Trail
                        <span class="badge bg-secondary ms-2"><%= pagination.totalItems %> entries</span>
                    </h5>
                    <small class="text-muted">
                        Page <%= pagination.currentPage %> of <%= pagination.totalPages %>
                    </small>
                </div>
                <div class="card-body p-0">
                    <% if (auditLogs && auditLogs.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Entity</th>
                                        <th>Result</th>
                                        <th>IP Address</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% auditLogs.forEach(log => { %>
                                        <tr class="<%= log.result === 'FAILURE' ? 'table-danger' : '' %>">
                                            <td>
                                                <small>
                                                    <%= new Date(log.timestamp).toLocaleString() %>
                                                </small>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <% if (log.userId) { %>
                                                        <i class="bi bi-person-circle text-primary me-2"></i>
                                                        <div>
                                                            <strong><%= log.userName %></strong><br>
                                                            <small class="text-muted"><%= log.userEmail %></small>
                                                        </div>
                                                    <% } else { %>
                                                        <i class="bi bi-gear-fill text-secondary me-2"></i>
                                                        <span class="text-muted">System</span>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-<%= log.result === 'SUCCESS' ? 'primary' : 'warning' %>">
                                                    <%= log.action.replace(/_/g, ' ') %>
                                                </span>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong><%= log.entityType %></strong>
                                                    <% if (log.entityId) { %>
                                                        <br><small class="text-muted">ID: <%= log.entityId %></small>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td>
                                                <% if (log.result === 'SUCCESS') { %>
                                                    <span class="badge bg-primary">
                                                        <i class="bi bi-check-lg"></i> Success
                                                    </span>
                                                <% } else { %>
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-x-lg"></i> Failed
                                                    </span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <%= log.ipAddress || 'N/A' %>
                                                </small>
                                            </td>
                                            <td>
                                                <% if (log.hasChanges || Object.keys(log.metadata).length > 0) { %>
                                                    <button class="btn btn-sm btn-outline-success" 
                                                            type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#details-<%= log.id %>" 
                                                            aria-expanded="false">
                                                        <i class="bi bi-info-circle"></i> Details
                                                    </button>
                                                <% } else { %>
                                                    <span class="text-muted">-</span>
                                                <% } %>
                                            </td>
                                        </tr>
                                        <% if (log.hasChanges || Object.keys(log.metadata).length > 0) { %>
                                            <tr class="collapse" id="details-<%= log.id %>">
                                                <td colspan="7" class="bg-light">
                                                    <div class="p-3">
                                                        <% if (Object.keys(log.metadata).length > 0) { %>
                                                            <div class="mb-3">
                                                                <h6><i class="bi bi-info-circle"></i> Metadata</h6>
                                                                <pre class="bg-white p-2 border rounded"><%= JSON.stringify(log.metadata, null, 2) %></pre>
                                                            </div>
                                                        <% } %>
                                                        <% if (log.hasChanges) { %>
                                                            <h6><i class="bi bi-arrow-left-right"></i> Data Changes</h6>
                                                            <small class="text-muted">Only showing changes made during this action</small>
                                                        <% } %>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% } %>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="text-center py-5">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <h4 class="mt-3">No Audit Logs Found</h4>
                            <p class="text-muted">
                                <% if (Object.values(filters).some(f => f)) { %>
                                    No audit logs match your current filters. Try adjusting your search criteria.
                                <% } else { %>
                                    No audit logs have been recorded yet.
                                <% } %>
                            </p>
                        </div>
                    <% } %>
                </div>
                
                <!-- Pagination -->
                <% if (pagination.totalPages > 1) { %>
                    <div class="card-footer">
                        <nav>
                            <ul class="pagination justify-content-center mb-0">
                                <% if (pagination.hasPrev) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= pagination.currentPage - 1 %><%= Object.keys(filters).some(key => filters[key]) ? '&' + Object.entries(filters).filter(([key, value]) => value).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&') : '' %>">
                                            <i class="bi bi-chevron-left"></i> Previous
                                        </a>
                                    </li>
                                <% } %>
                                
                                <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
                                    <li class="page-item <%= pagination.currentPage === i ? 'active' : '' %>">
                                        <a class="page-link" href="?page=<%= i %><%= Object.keys(filters).some(key => filters[key]) ? '&' + Object.entries(filters).filter(([key, value]) => value).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&') : '' %>">
                                            <%= i %>
                                        </a>
                                    </li>
                                <% } %>
                                
                                <% if (pagination.hasNext) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= pagination.currentPage + 1 %><%= Object.keys(filters).some(key => filters[key]) ? '&' + Object.entries(filters).filter(([key, value]) => value).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&') : '' %>">
                                            Next <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                <% } %>
                            </ul>
                        </nav>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
// Load audit statistics
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/admin/audit-logs/statistics');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('total-actions').textContent = data.stats.totalActions.toLocaleString();
            document.getElementById('successful-actions').textContent = data.stats.successfulActions.toLocaleString();
            document.getElementById('failed-actions').textContent = data.stats.failedActions.toLocaleString();
            document.getElementById('success-rate').textContent = data.stats.successRate + '%';
        } else {
            document.getElementById('audit-stats').innerHTML = '<div class="col-12"><div class="alert alert-warning">Unable to load audit statistics</div></div>';
        }
    } catch (error) {
        console.error('Error loading audit statistics:', error);
        document.getElementById('audit-stats').innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading audit statistics</div></div>';
    }
});
</script>